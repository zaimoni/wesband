[event]
	name=wbd manage equipment
	first_time_only=no

	{WBD_INVENTORY_CANCEL_STACK_PUSH (_ "equipment change")}
	{VARIABLE menu.level 1}
	[while]
		[variable]
			name=menu.level
			equals=1
		[/variable]
		[do]
			[set_variables]
				name=menu.insert
				mode=replace
				[value]
					{WBD_DISPLAY_WEAPON current.unit.variables.inventory.weapons.melee[$current.unit.variables.equipment_slots.melee_1] $current.unit.attack[0].damage| $current.unit.attack[0].number|}
					[command]
						{VARIABLE menu.slot.type current.unit.variables.inventory.weapons.melee}
						{VARIABLE menu.slot.id current.unit.variables.equipment_slots.melee_1}
						{FIRE_EVENT "wbd manage slot"}
					[/command]
				[/value]
			[/set_variables]
			[if]
				[variable]
					name=current.unit.variables.abilities.wield
					greater_than=0
				[/variable]
				[and]
					[variable]
						name=current.unit.variables.inventory.armor.shield[$current.unit.variables.equipment_slots.shield].block_wield
						not_equals=2
					[/variable]
				[/and]
				[then]
					[set_variables]
						name=menu.insert
						mode=append
						[value]
							{WBD_DISPLAY_WEAPON current.unit.variables.inventory.weapons.melee[$current.unit.variables.equipment_slots.melee_2] $current.unit.attack[1].damage| $current.unit.attack[1].number|}
							[command]
								{VARIABLE menu.slot.type current.unit.variables.inventory.weapons.melee}
								{VARIABLE menu.slot.id current.unit.variables.equipment_slots.melee_2}
								{FIRE_EVENT "wbd manage slot"}
							[/command]
						[/value]
					[/set_variables]
					[if]
						[variable]
							name=current.unit.variables.abilities.wield
							equals=2
						[/variable]
						[and]
							[variable]
								name=current.unit.variables.inventory.armor.shield[$current.unit.variables.equipment_slots.shield].block_wield
								equals=0
							[/variable]
						[/and]
						[then]
							[set_variables]
								name=menu.insert
								mode=append
								[value]
									{WBD_DISPLAY_WEAPON current.unit.variables.inventory.weapons.melee[$current.unit.variables.equipment_slots.melee_3] $current.unit.attack[2].damage| $current.unit.attack[2].number|}
									[command]
										{VARIABLE menu.slot.type current.unit.variables.inventory.weapons.melee}
										{VARIABLE menu.slot.id current.unit.variables.equipment_slots.melee_3}
										{FIRE_EVENT "wbd manage slot"}
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]
				[/then]
			[/if]
			{IF_VAR current.unit.variables.inventory.armor.shield[$current.unit.variables.equipment_slots.shield].block_ranged equals 0 (
				[then]
					{VARIABLE unit_path current.unit}
					[calculate_weapon_display]
						unit_variable=current.unit
						weapon_variable=current.unit.variables.inventory.weapons.ranged[$current.unit.variables.equipment_slots.ranged]
					[/calculate_weapon_display]
					[set_variables]
						name=menu.insert
						mode=append
						[value]
							{WBD_DISPLAY_WEAPON current.unit.variables.inventory.weapons.ranged[$current.unit.variables.equipment_slots.ranged] $display_damage| $display_number|}
							[command]
								{VARIABLE menu.slot.type current.unit.variables.inventory.weapons.ranged}
								{VARIABLE menu.slot.id current.unit.variables.equipment_slots.ranged}
								{FIRE_EVENT "wbd manage slot"}
							[/command]
						[/value]
					[/set_variables]
				[/then]
			)}
			{IF_VAR current.unit.variables.inventory.armor.torso[$current.unit.variables.equipment_slots.torso_armor].restricts.shield equals 0 (
				[then]
					[set_variables]
						name=menu.insert
						mode=append
						[value]
							{DISPLAY_SHIELD current.unit.variables.inventory.armor.shield[$current.unit.variables.equipment_slots.shield]}
							[command]
								{VARIABLE menu.slot.type current.unit.variables.inventory.armor.shield}
								{VARIABLE menu.slot.id current.unit.variables.equipment_slots.shield}
								{FIRE_EVENT "wbd manage slot"}
							[/command]
						[/value]
					[/set_variables]
				[/then]
			)}
			{IF_VAR current.unit.variables.inventory.armor.torso[$current.unit.variables.equipment_slots.torso_armor].restricts.head equals 0 (
				[then]
					[set_variables]
						name=menu.insert
						mode=append
						[value]
							{DISPLAY_HEAD_ARMOR current.unit.variables.inventory.armor.head[$current.unit.variables.equipment_slots.head_armor]}
							[command]
								{VARIABLE menu.slot.type current.unit.variables.inventory.armor.head}
								{VARIABLE menu.slot.id current.unit.variables.equipment_slots.head_armor}
								{FIRE_EVENT "wbd manage slot"}
							[/command]
						[/value]
					[/set_variables]
				[/then]
			)}
			[set_variables]
				name=menu.insert
				mode=append
				[value]
					{DISPLAY_TORSO_ARMOR current.unit.variables.inventory.armor.torso[$current.unit.variables.equipment_slots.torso_armor]}
					[command]
						{VARIABLE menu.slot.type current.unit.variables.inventory.armor.torso}
						{VARIABLE menu.slot.id current.unit.variables.equipment_slots.torso_armor}
						{FIRE_EVENT "wbd manage slot"}
					[/command]
				[/value]
			[/set_variables]
			{IF_VAR current.unit.variables.inventory.armor.torso[$current.unit.variables.equipment_slots.torso_armor].restricts.legs equals 0 (
				[then]
					[set_variables]
						name=menu.insert
						mode=append
						[value]
							{DISPLAY_LEGS_ARMOR current.unit.variables.inventory.armor.legs[$current.unit.variables.equipment_slots.leg_armor]}
							[command]
								{VARIABLE menu.slot.type current.unit.variables.inventory.armor.legs}
								{VARIABLE menu.slot.id current.unit.variables.equipment_slots.leg_armor}
								{FIRE_EVENT "wbd manage slot"}
							[/command]
						[/value]
					[/set_variables]
				[/then]
			)}
			{WBD_PAPERDOLL_CALCS}
			[message]
				speaker=narrator
				side_for=$side_number
				{WBD_DISPLAY_PAPERDOLL}

				[option]
					message="&"+check.png+"="+_ "(Done - accept current equipment)"
					[show_if]
						[variable]
							name=current.action.expended
							greater_than=1
						[/variable]
					[/show_if]
					[command]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[option]
					message="&"+check.png+"="+_ "(Done - using original equipment)"
					[show_if]
						[variable]
							name=current.action.expended
							less_than=2
						[/variable]
					[/show_if]
					[command]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					message="&"+check.png+"="+_ "(Cancel - undo latest changes)"
					[command]
						{CLEAR_VARIABLE menu.action_flag}
						{VARIABLE menu.level 0}
					[/command]
				[/option]
			[/message]
		[/do]
	[/while]
	{IF_VAR menu.action_flag equals 1 (
		[then]
			{CLEAR_VARIABLE menu.action_flag}
		[/then]
		[else]
			{WBD_INVENTORY_CANCEL_STACK_POP}
		[/else]
	)}
[/event]

[event]
	name=wbd manage slot
	first_time_only=no

	{VARIABLE menu.cancel_id $$menu.slot.id}
	{VARIABLE menu.level 2}
	[while]
		[variable]
			name=menu.level
			equals=2
		[/variable]
		[do]
			[switch]
				variable=menu.slot.id
				[case]
					value=current.unit.variables.equipment_slots.shield
					{VARIABLE menu.message (_ "Select Shield (Currently Equipped At Top)")}
					[set_variables]
						name=menu.insert
						mode=replace
						[value]
							{DISPLAY_SHIELD $menu.slot.type|[$$menu.slot.id]}
						[/value]
					[/set_variables]
					{FOREACH $menu.slot.type| i}
						{IF_VAR $menu.slot.id not_equals $i (
							[then]
								[set_variables]
									name=menu.insert
									mode=append
									[value]
										{DISPLAY_SHIELD $menu.slot.type|[$i]}
										[command]
											{VARIABLE $menu.slot.id $i}
											[construct_unit]
												variable=current.unit
											[/construct_unit]
										[/command]
									[/value]
								[/set_variables]
							[/then]
						)}
					{NEXT i}
				[/case]
				[case]
					value=current.unit.variables.equipment_slots.head_armor
					{VARIABLE menu.message (_ "Select head armor (currently equipped at top)")}
					[set_variables]
						name=menu.insert
						mode=replace
						[value]
							{DISPLAY_HEAD_ARMOR $menu.slot.type|[$$menu.slot.id]}
						[/value]
					[/set_variables]
					{FOREACH $menu.slot.type| i}
						{IF_VAR $menu.slot.id not_equals $i (
							[then]
								[set_variables]
									name=menu.insert
									mode=append
									[value]
										{DISPLAY_HEAD_ARMOR $menu.slot.type|[$i]}
										[command]
											{VARIABLE $menu.slot.id $i}
											[construct_unit]
												variable=current.unit
											[/construct_unit]
										[/command]
									[/value]
								[/set_variables]
							[/then]
						)}
					{NEXT i}
				[/case]
				[case]
					value=current.unit.variables.equipment_slots.torso_armor
					{VARIABLE menu.message (_ "Select torso armor (currently equipped at top)")}
					[set_variables]
						name=menu.insert
						mode=replace
						[value]
							{DISPLAY_TORSO_ARMOR $menu.slot.type|[$$menu.slot.id]}
						[/value]
					[/set_variables]
					{FOREACH $menu.slot.type| i}
						{IF_VAR $menu.slot.id not_equals $i (
							[then]
								[set_variables]
									name=menu.insert
									mode=append
									[value]
										{DISPLAY_TORSO_ARMOR $menu.slot.type|[$i]}
										[command]
											{VARIABLE $menu.slot.id $i}
											[construct_unit]
												variable=current.unit
											[/construct_unit]
										[/command]
									[/value]
								[/set_variables]
							[/then]
						)}
					{NEXT i}
				[/case]
				[case]
					value=current.unit.variables.equipment_slots.leg_armor
					{VARIABLE menu.message (_ "Select leg armor (currently equipped at top)")}
					[set_variables]
						name=menu.insert
						mode=replace
						[value]
							{DISPLAY_LEGS_ARMOR $menu.slot.type|[$$menu.slot.id]}
						[/value]
					[/set_variables]
					{FOREACH $menu.slot.type| i}
						{IF_VAR $menu.slot.id not_equals $i (
							[then]
								[set_variables]
									name=menu.insert
									mode=append
									[value]
										{DISPLAY_LEGS_ARMOR $menu.slot.type|[$i]}
										[command]
											{VARIABLE $menu.slot.id $i}
											[construct_unit]
												variable=current.unit
											[/construct_unit]
										[/command]
									[/value]
								[/set_variables]
							[/then]
						)}
					{NEXT i}
				[/case]
				[else]
					[switch]
						variable=menu.slot.id
						[case]
							value=current.unit.variables.equipment_slots.melee_1
							{VARIABLE menu.message (_ "Select primary melee weapon (currently equipped at top)")}
						[/case]
						[case]
							value=current.unit.variables.equipment_slots.melee_2
							{VARIABLE menu.message (_ "Select secondary melee weapon (currently equipped at top)")}
						[/case]
						[case]
							value=current.unit.variables.equipment_slots.melee_3
							{VARIABLE menu.message (_ "Select tertiary melee weapon (currently equipped at top)")}
						[/case]
						[else]
							{VARIABLE menu.message (_ "Select ranged weapon (currently equipped at top)")}
						[/else]
					[/switch]
					{VARIABLE unit_path current.unit}
					[calculate_weapon_display]
						unit_variable=current.unit
						weapon_variable=$menu.slot.type|[$$menu.slot.id]
					[/calculate_weapon_display]
					[set_variables]
						name=menu.insert
						mode=replace
						[value]
							{WBD_DISPLAY_WEAPON $menu.slot.type|[$$menu.slot.id] $display_damage| $display_number|}
						[/value]
					[/set_variables]
					{VARIABLE unit_path current.unit}
					{FOREACH $menu.slot.type| i}
						{IF_VAR $menu.slot.id not_equals $i (
							[then]
								[calculate_weapon_display]
									unit_variable=current.unit
									weapon_variable=$menu.slot.type|[$i]
								[/calculate_weapon_display]
								[set_variables]
									name=menu.insert
									mode=append
									[value]
										{WBD_DISPLAY_WEAPON $menu.slot.type|[$i] $display_damage| $display_number|}
										[command]
											{VARIABLE $menu.slot.id $i}
											[construct_unit]
												variable=current.unit
											[/construct_unit]
										[/command]
									[/value]
								[/set_variables]
							[/then]
						)}
					{NEXT i}
				[/else]
			[/switch]
			[message]
				speaker=narrator
				side_for=$side_number
				message=$menu.message
				[option]
					message="&"+check.png+"="+_ "(Accept equipment)"
					[command]
						{IF_VAR current.unit.variables.inventory.armor.torso[$current.unit.variables.equipment_slots.torso_armor].restricts.head greater_than 0 (
							[then]
								{VARIABLE current.unit.variables.equipment_slots.head_armor 0}
							[/then]
						)}
						{IF_VAR current.unit.variables.inventory.armor.torso[$current.unit.variables.equipment_slots.torso_armor].restricts.legs greater_than 0 (
							[then]
								{VARIABLE current.unit.variables.equipment_slots.leg_armor 0}
							[/then]
						)}
						{IF_VAR current.unit.variables.inventory.armor.torso[$current.unit.variables.equipment_slots.torso_armor].restricts.shield greater_than 0 (
							[then]
								{VARIABLE current.unit.variables.equipment_slots.shield 0}
							[/then]
						)}
						{IF_VAR current.unit.variables.inventory.armor.shield[$current.unit.variables.equipment_slots.shield].block_wield greater_than 1 (
							[then]
								{VARIABLE current.unit.variables.equipment_slots.melee_2 0}
							[/then]
						)}
						{IF_VAR current.unit.variables.inventory.armor.shield[$current.unit.variables.equipment_slots.shield].block_wield greater_than 0 (
							[then]
								{VARIABLE current.unit.variables.equipment_slots.melee_3 0}
							[/then]
						)}
						[if]
							[variable]
								name=current.unit.variables.equipment_slots.melee_1
								not_equals=$current.start_equip.primary
							[/variable]
							[or]
								[variable]
									name=current.unit.variables.equipment_slots.melee_2
									not_equals=$current.start_equip.secondary
								[/variable]
							[/or]
							[or]
								[variable]
									name=current.unit.variables.equipment_slots.melee_3
									not_equals=$current.start_equip.tertiary
								[/variable]
							[/or]
							[or]
								[variable]
									name=current.unit.variables.equipment_slots.ranged
									not_equals=$current.start_equip.ranged
								[/variable]
							[/or]
							[or]
								[variable]
									name=current.unit.variables.equipment_slots.shield
									not_equals=$current.start_equip.shield
								[/variable]
							[/or]
							[or]
								[variable]
									name=current.unit.variables.equipment_slots.head_armor
									not_equals=$current.start_equip.head
								[/variable]
							[/or]
							[or]
								[variable]
									name=current.unit.variables.equipment_slots.torso_armor
									not_equals=$current.start_equip.torso
								[/variable]
							[/or]
							[or]
								[variable]
									name=current.unit.variables.equipment_slots.leg_armor
									not_equals=$current.start_equip.legs
								[/variable]
							[/or]
							[then]
								{IF_VAR current.action.expended less_than 2 (
									[then]
										{VARIABLE_OP current.action.expended add 2}
									[/then]
								)}
							[/then]
							[else]
								{IF_VAR current.action.expended greater_than 1 (
									[then]
										{VARIABLE_OP current.action.expended sub 2}
									[/then]
								)}
							[/else]
						[/if]
						{IF_VAR $menu.slot.id not_equals $menu.cancel_id (
							[then]
								{VARIABLE menu.action_flag 1}
							[/then]
						)}
						{VARIABLE menu.level 1}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					message="&"+x.png+"="+_ "(Cancel equipment change)"
					[command]
						{IF_VAR $menu.slot.id not_equals $menu.cancel_id (
							[then]
								{VARIABLE $menu.slot.id $menu.cancel_id}
								[construct_unit]
									variable=current.unit
								[/construct_unit]
							[/then]
						)}
						{VARIABLE menu.level 1}
					[/command]
				[/option]
			[/message]
		[/do]
	[/while]
[/event]

[event]
	name=wbd view equipment
	first_time_only=no

	{VARIABLE menu.level 1}
	[while]
		[variable]
			name=menu.level
			equals=1
		[/variable]
		[do]
			{VARIABLE unit_path current.unit}
			[calculate_weapon_display]
				unit_variable=current.unit
				weapon_variable=current.unit.variables.inventory.weapons.melee[$current.unit.variables.equipment_slots.melee_1]
			[/calculate_weapon_display]
			[set_variables]
				name=menu.insert
				mode=replace
				[value]
					{DISPLAY_WEAPON current.unit.variables.inventory.weapons.melee[$current.unit.variables.equipment_slots.melee_1]}
				[/value]
			[/set_variables]
			[if]
				[variable]
					name=current.unit.variables.abilities.wield
					greater_than=0
				[/variable]
				[and]
					[variable]
						name=current.unit.variables.inventory.armor.shield[$current.unit.variables.equipment_slots.shield].block_wield
						not_equals=2
					[/variable]
				[/and]
				[then]
					{VARIABLE unit_path current.unit}
					[calculate_weapon_display]
						unit_variable=current.unit
						weapon_variable=current.unit.variables.inventory.weapons.melee[$current.unit.variables.equipment_slots.melee_2]
					[/calculate_weapon_display]
					[set_variables]
						name=menu.insert
						mode=append
						[value]
							{DISPLAY_WEAPON current.unit.variables.inventory.weapons.melee[$current.unit.variables.equipment_slots.melee_2]}
						[/value]
					[/set_variables]
					[if]
						[variable]
							name=current.unit.variables.abilities.wield
							equals=2
						[/variable]
						[and]
							[variable]
								name=current.unit.variables.inventory.armor.shield[$current.unit.variables.equipment_slots.shield].block_wield
								equals=0
							[/variable]
						[/and]
						[then]
							{VARIABLE unit_path current.unit}
							[calculate_weapon_display]
								unit_variable=current.unit
								weapon_variable=current.unit.variables.inventory.weapons.melee[$current.unit.variables.equipment_slots.melee_3]
							[/calculate_weapon_display]
							[set_variables]
								name=menu.insert
								mode=append
								[value]
									{DISPLAY_WEAPON current.unit.variables.inventory.weapons.melee[$current.unit.variables.equipment_slots.melee_3]}
								[/value]
							[/set_variables]
						[/then]
					[/if]
				[/then]
			[/if]
			{IF_VAR current.unit.variables.inventory.armor.shield[$current.unit.variables.equipment_slots.shield].block_ranged equals 0 (
				[then]
					{VARIABLE unit_path current.unit}
					[calculate_weapon_display]
						unit_variable=current.unit
						weapon_variable=current.unit.variables.inventory.weapons.ranged[$current.unit.variables.equipment_slots.ranged]
					[/calculate_weapon_display]
					[set_variables]
						name=menu.insert
						mode=append
						[value]
							{DISPLAY_WEAPON current.unit.variables.inventory.weapons.ranged[$current.unit.variables.equipment_slots.ranged]}
						[/value]
					[/set_variables]
				[/then]
			)}
			{IF_VAR current.unit.variables.inventory.armor.torso[$current.unit.variables.equipment_slots.torso_armor].restricts.shield equals 0 (
				[then]
					[set_variables]
						name=menu.insert
						mode=append
						[value]
							{DISPLAY_SHIELD current.unit.variables.inventory.armor.shield[$current.unit.variables.equipment_slots.shield]}
						[/value]
					[/set_variables]
				[/then]
			)}
			{IF_VAR current.unit.variables.inventory.armor.torso[$current.unit.variables.equipment_slots.torso_armor].restricts.head equals 0 (
				[then]
					[set_variables]
						name=menu.insert
						mode=append
						[value]
							{DISPLAY_HEAD_ARMOR current.unit.variables.inventory.armor.head[$current.unit.variables.equipment_slots.head_armor]}
						[/value]
					[/set_variables]
				[/then]
			)}
			[set_variables]
				name=menu.insert
				mode=append
				[value]
					{DISPLAY_TORSO_ARMOR current.unit.variables.inventory.armor.torso[$current.unit.variables.equipment_slots.torso_armor]}
				[/value]
			[/set_variables]
			{IF_VAR current.unit.variables.inventory.armor.torso[$current.unit.variables.equipment_slots.torso_armor].restricts.legs equals 0 (
				[then]
					[set_variables]
						name=menu.insert
						mode=append
						[value]
							{DISPLAY_LEGS_ARMOR current.unit.variables.inventory.armor.legs[$current.unit.variables.equipment_slots.leg_armor]}
						[/value]
					[/set_variables]
				[/then]
			)}
			{WBD_PAPERDOLL_CALCS}
			[message]
				speaker=narrator
				side_for=$side_number
				{WBD_DISPLAY_PAPERDOLL}

				[option]
					message="&"+check.png+"="+_ "(Back)"
					[command]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
			[/message]
		[/do]
	[/while]
[/event]

[event]
	name=wbd thunderstick tinker
	first_time_only=no

	{WBD_INVENTORY_CANCEL_STACK_PUSH (_ "tinkering")}
	{VARIABLE menu.level 1}
	[while]
		[variable]
			name=menu.level
			equals=1
		[/variable]
		[do]
			{CLEAR_VARIABLE menu.insert}
			{FOREACH current.unit.variables.inventory.weapons.ranged i}
				{IF_VAR current.unit.variables.inventory.weapons.ranged[$i].user_name equals thunderstick (
					[then]
						{IF_VAR current.unit.variables.inventory.weapons.ranged[$i].level less_than $current.unit.variables.abilities.thunderstick_tinker (
							[then]
								[set_variables]
									name=menu.insert
									mode=append
									[value]
										message="&"+attacks/$current.unit.variables.inventory.weapons.ranged[$i].icon|.png+"="+_ "$current.unit.variables.inventory.weapons.ranged[$i].description|
<small>Damage: $current.unit.variables.inventory.weapons.ranged[$i].damage|, Shots: $current.unit.variables.inventory.weapons.ranged[$i].number|, Level: $current.unit.variables.inventory.weapons.ranged[$i].level|</small>"
									[/value]
								[/set_variables]
								[set_variables]
									name=menu.insert
									mode=append
									[value]
										message="&" "="+_ "Add 25% to damage."
										[command]
											{VARIABLE_OP current.unit.variables.inventory.weapons.ranged[$i].damage multiply 1.25}
											{VARIABLE_OP current.unit.variables.inventory.weapons.ranged[$i].max_damage multiply 1.25}
											{VARIABLE_OP current.unit.variables.inventory.weapons.ranged[$i].level add 1}
											{IF_VAR current.unit.variables.equipment_slots.ranged equals $i (
												[then]
													[construct_unit]
														variable=current.unit
													[/construct_unit]
												[/then]
											)}
											{VARIABLE menu.action_flag 1}
										[/command]
									[/value]
								[/set_variables]
								{IF_VAR current.unit.variables.inventory.weapons.ranged[$i].damage greater_than_equal_to 20 (
									[then]
										[set_variables]
											name=menu.insert
											mode=append
											[value]
												message="&" "="+_ "Double the shots and halve the damage."
												[command]
													{VARIABLE_OP current.unit.variables.inventory.weapons.ranged[$i].number multiply 2}
													{VARIABLE_OP current.unit.variables.inventory.weapons.ranged[$i].damage multiply .5}
													{VARIABLE_OP current.unit.variables.inventory.weapons.ranged[$i].max_damage multiply .5}
													{VARIABLE_OP current.unit.variables.inventory.weapons.ranged[$i].level add 1}
													{IF_VAR current.unit.variables.equipment_slots.ranged equals $i (
														[then]
															[construct_unit]
																variable=current.unit
															[/construct_unit]
														[/then]
													)}
													{VARIABLE menu.action_flag 1}
												[/command]
											[/value]
										[/set_variables]
									[/then]
									[else]
										[set_variables]
											name=menu.insert
											mode=append
											[value]
												message="&" "="+_ "Damage is too low to increase number of shots."
											[/value]
										[/set_variables]
									[/else]
								)}
							[/then]
							[else]
								[set_variables]
									name=menu.insert
									mode=append
									[value]
										message="&"+attacks/$current.unit.variables.inventory.weapons.ranged[$i].icon|.png+"="+_ "$current.unit.variables.inventory.weapons.ranged[$i].description|
<small>Damage: $current.unit.variables.inventory.weapons.ranged[$i].damage|, Shots: $current.unit.variables.inventory.weapons.ranged[$i].number|, Level: $current.unit.variables.inventory.weapons.ranged[$i].level|
Requires upgrade to tinker skill</small>"
									[/value]
								[/set_variables]
							[/else]
						)}
					[/then]
				)}
			{NEXT i}
			[message]
				speaker=narrator
				side_for=$side_number
				message= _ "You can improve thundersticks that are under level $current.unit.variables.abilities.thunderstick_tinker|. You may either add 25% to the damage or double the number of shots in combat but this cuts their damage in half.
You may not decrease the damage below 10."
				[option]
					message="&"+check.png+"="+_ "(Done - Accept Changes)"
					[command]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					message="&"+x.png+"="+_ "(Cancel - Undo Latest Changes)"
					[command]
						{CLEAR_VARIABLE menu.action_flag}
						{VARIABLE menu.level 0}
					[/command]
				[/option]
			[/message]
		[/do]
	[/while]
	{IF_VAR menu.action_flag equals 1 (
		[then]
			{CLEAR_VARIABLE menu.action_flag}
		[/then]
		[else]
			{WBD_INVENTORY_CANCEL_STACK_POP}
		[/else]
	)}
[/event]

[event]
	name=wbd get items
	first_time_only=no

	{WBD_INVENTORY_CANCEL_STACK_PUSH (_ "item pickup")}
	{VARIABLE menu.level 1}
	[while]
		[variable]
			name=menu.level
			equals=1
		[/variable]
		[do]
			{CLEAR_VARIABLE menu.insert}
			{FOREACH ground.x$menu.location.x|.y$menu.location.y|.items i}
				[switch]
					variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i].category
					[case]
						value=melee_weapon
						{VARIABLE unit_path current.unit}
						[calculate_weapon_display]
							unit_variable=current.unit
							weapon_variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
						[/calculate_weapon_display]
						[set_variables]
							name=menu.insert
							mode=append
							[value]
								{WBD_DISPLAY_WEAPON ground.x$menu.location.x|.y$menu.location.y|.items[$i] $display_damage| $display_number|}
								[command]
									[set_variables]
										name=current.unit.variables.inventory.weapons.melee
										mode=append
										[insert_tag]
											name=literal
											variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
										[/insert_tag]
									[/set_variables]
									[item_cleanup]
										x=$menu.location.x
										y=$menu.location.y
										index=$i
									[/item_cleanup]
									{VARIABLE menu.action_flag 1}
								[/command]
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=ranged_weapon
						{VARIABLE unit_path current.unit}
						[calculate_weapon_display]
							unit_variable=current.unit
							weapon_variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
						[/calculate_weapon_display]
						[set_variables]
							name=menu.insert
							mode=append
							[value]
								{WBD_DISPLAY_WEAPON ground.x$menu.location.x|.y$menu.location.y|.items[$i] $display_damage| $display_number|}
								[command]
									[set_variables]
										name=current.unit.variables.inventory.weapons.ranged
										mode=append
										[insert_tag]
											name=literal
											variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
										[/insert_tag]
									[/set_variables]
									{IF_VAR ground.x$menu.location.x|.y$menu.location.y|.items[$i].user_name equals thunderstick (
										[then]
											[construct_unit]
												variable=current.unit
											[/construct_unit]
										[/then]
									)}
									[item_cleanup]
										x=$menu.location.x
										y=$menu.location.y
										index=$i
									[/item_cleanup]
									{VARIABLE menu.action_flag 1}
								[/command]
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=shield
						[set_variables]
							name=menu.insert
							mode=append
							[value]
								{DISPLAY_SHIELD ground.x$menu.location.x|.y$menu.location.y|.items[$i]}
								[command]
									[set_variables]
										name=current.unit.variables.inventory.armor.shield
										mode=append
										[insert_tag]
											name=literal
											variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
										[/insert_tag]
									[/set_variables]
									[item_cleanup]
										x=$menu.location.x
										y=$menu.location.y
										index=$i
									[/item_cleanup]
									{VARIABLE menu.action_flag 1}
								[/command]
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=head_armor
						[set_variables]
							name=menu.insert
							mode=append
							[value]
								{DISPLAY_HEAD_ARMOR ground.x$menu.location.x|.y$menu.location.y|.items[$i]}
								[command]
									[set_variables]
										name=current.unit.variables.inventory.armor.head
										mode=append
										[insert_tag]
											name=literal
											variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
										[/insert_tag]
									[/set_variables]
									[item_cleanup]
										x=$menu.location.x
										y=$menu.location.y
										index=$i
									[/item_cleanup]
									{VARIABLE menu.action_flag 1}
								[/command]
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=torso_armor
						[set_variables]
							name=menu.insert
							mode=append
							[value]
								{DISPLAY_TORSO_ARMOR ground.x$menu.location.x|.y$menu.location.y|.items[$i]}
								[command]
									[set_variables]
										name=current.unit.variables.inventory.armor.torso
										mode=append
										[insert_tag]
											name=literal
											variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
										[/insert_tag]
									[/set_variables]
									[item_cleanup]
										x=$menu.location.x
										y=$menu.location.y
										index=$i
									[/item_cleanup]
									{VARIABLE menu.action_flag 1}
								[/command]
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=legs_armor
						[set_variables]
							name=menu.insert
							mode=append
							[value]
								{DISPLAY_LEGS_ARMOR ground.x$menu.location.x|.y$menu.location.y|.items[$i]}
								[command]
									[set_variables]
										name=current.unit.variables.inventory.armor.legs
										mode=append
										[insert_tag]
											name=literal
											variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
										[/insert_tag]
									[/set_variables]
									[item_cleanup]
										x=$menu.location.x
										y=$menu.location.y
										index=$i
									[/item_cleanup]
									{VARIABLE menu.action_flag 1}
								[/command]
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=usables
						[set_variables]
							name=menu.insert
							mode=append
							[value]
								message="&"+$ground.x$menu.location.x|.y$menu.location.y|.items[$i].icon|.png+"="+_ "$ground.x$menu.location.x|.y$menu.location.y|.items[$i].description"
								[command]
									[set_variables]
										name=current.unit.variables.inventory.usables
										mode=append
										[insert_tag]
											name=literal
											variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
										[/insert_tag]
									[/set_variables]
									[item_cleanup]
										x=$menu.location.x
										y=$menu.location.y
										index=$i
									[/item_cleanup]
									{VARIABLE menu.action_flag 1}
								[/command]
							[/value]
						[/set_variables]
					[/case]
					[case]
						value=gold
						[set_variables]
							name=menu.insert
							mode=append
							[value]
								message="&"+$ground.x$menu.location.x|.y$menu.location.y|.items[$i].icon|.png+"="+_ "$ground.x$menu.location.x|.y$menu.location.y|.items[$i].description"
								[command]
									{IF_VAR menu.construct_type equals pc (
										[then]
											{VARIABLE_OP current.unit.variables.personal_gold add $ground.x$menu.location.x|.y$menu.location.y|.items[$i].amount}
											[modify_side]
												side=$current.unit.side
												gold=$|current.unit.variables.personal_gold
											[/modify_side]
										[/then]
										[else]
											{VARIABLE_OP current.leader.variables.personal_gold add $ground.x$menu.location.x|.y$menu.location.y|.items[$i].amount}
											[modify_side]
												side=$current.unit.side
												gold=$|current.leader.variables.personal_gold
											[/modify_side]
											[unstore_unit]
												variable=current.leader
											[/unstore_unit]
										[/else]
									)}
									[item_cleanup]
										x=$menu.location.x
										y=$menu.location.y
										index=$i
									[/item_cleanup]
									{VARIABLE menu.action_flag 1}
								[/command]
							[/value]
						[/set_variables]
					[/case]
				[/switch]
			{NEXT i}
			[message]
				speaker=narrator
				side_for=$side_number
				message= _ "Get which item?"
				[option]
					message="&"+check.png+"="+_ "(End)"
					[command]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[option]
					message="&"+icons/get-all.png+"="+_ "Get all"
					[show_if]
						[variable]
							name=menu.insert.length
							greater_than=1
						[/variable]
					[/show_if]
					[command]
						{FOREACH_COLLAPSE ground.x$menu.location.x|.y$menu.location.y|.items i}
							[switch]
								variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i].category
								[case]
									value=melee_weapon
									[set_variables]
										name=current.unit.variables.inventory.weapons.melee
										mode=append
										[insert_tag]
											name=literal
											variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
										[/insert_tag]
									[/set_variables]
								[/case]
								[case]
									value=ranged_weapon
									[set_variables]
										name=current.unit.variables.inventory.weapons.ranged
										mode=append
										[insert_tag]
											name=literal
											variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
										[/insert_tag]
									[/set_variables]
									{IF_VAR ground.x$menu.location.x|.y$menu.location.y|.items[$i].user_name equals thunderstick (
										[then]
											[construct_unit]
												variable=current.unit
											[/construct_unit]
										[/then]
									)}
								[/case]
								[case]
									value=shield
									[set_variables]
										name=current.unit.variables.inventory.armor.shield
										mode=append
										[insert_tag]
											name=literal
											variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
										[/insert_tag]
									[/set_variables]
								[/case]
								[case]
									value=head_armor
									[set_variables]
										name=current.unit.variables.inventory.armor.head
										mode=append
										[insert_tag]
											name=literal
											variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
										[/insert_tag]
									[/set_variables]
								[/case]
								[case]
									value=torso_armor
									[set_variables]
										name=current.unit.variables.inventory.armor.torso
										mode=append
										[insert_tag]
											name=literal
											variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
										[/insert_tag]
									[/set_variables]
								[/case]
								[case]
									value=legs_armor
									[set_variables]
										name=current.unit.variables.inventory.armor.legs
										mode=append
										[insert_tag]
											name=literal
											variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
										[/insert_tag]
									[/set_variables]
								[/case]
								[case]
									value=usables
									[set_variables]
										name=current.unit.variables.inventory.usables
										mode=append
										[insert_tag]
											name=literal
											variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
										[/insert_tag]
									[/set_variables]
								[/case]
								[case]
									value=gold
									{IF_VAR current.unit.canrecruit equals yes (
										[then]
											{VARIABLE_OP current.unit.variables.personal_gold add $ground.x$menu.location.x|.y$menu.location.y|.items[$i].amount}
											[modify_side]
												side=$current.unit.side
												gold=$current.unit.variables.personal_gold
											[/modify_side]
										[/then]
										[else]
											{VARIABLE_OP current.leader.variables.personal_gold add $ground.x$menu.location.x|.y$menu.location.y|.items[$i].amount}
											[modify_side]
												side=$current.unit.side
												gold=$current.leader.variables.personal_gold
											[/modify_side]
											[unstore_unit]
												variable=current.leader
											[/unstore_unit]
										[/else]
									)}
								[/case]
							[/switch]
						{NEXT_COLLAPSE i}
						[item_cleanup]
							x=$menu.location.x
							y=$menu.location.y
						[/item_cleanup]
						{VARIABLE menu.action_flag 1}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					message="&"+x.png+"="+_ "(Cancel)"
					[command]
						{CLEAR_VARIABLE menu.action_flag}
						{VARIABLE menu.level 0}
					[/command]
				[/option]
			[/message]
			{IF_VAR ground.x$menu.location.x|.y$menu.location.y|.items.length equals 0 (
				[then]
					{VARIABLE menu.level 0}
				[/then]
			)}
		[/do]
	[/while]
	[unstore_unit]
		variable=current.unit
	[/unstore_unit]
	{IF_VAR menu.action_flag equals 1 (
		[then]
			{IF_VAR current.action.expended less_than 2 (
				[then]
					{VARIABLE current.action.expended 1}
				[/then]
				[else]
					{VARIABLE current.action.expended 3}
				[/else]
			)}
			{CLEAR_VARIABLE menu.action_flag}
		[/then]
		[else]
			{WBD_INVENTORY_CANCEL_STACK_POP}
		[/else]
	)}
[/event]

[event]
	name=wbd give items
	first_time_only=no

	{CLEAR_VARIABLE menu.insert}
	{FOREACH current.adjacent i}
		[store_side]
			side=$current.adjacent[$i].side
			variable=menu.side_data
		[/store_side]
		[set_variables]
			name=menu.insert
			mode=append
			[value]
				message="&"+$current.adjacent[$i].image|~TC($current.adjacent[$i].side,magenta)+"="+_ "$current.adjacent[$i].name ($current.adjacent[$i].language_name)"
				[command]
					{VARIABLE menu.recipient $i}
					{VARIABLE menu.level 1}
				[/command]
			[/value]
		[/set_variables]
	{NEXT i}
	[message]
		speaker=narrator
		side_for=$side_number
		message=_ "Choose recipient"
		[insert_tag]
			name=option
			variable=menu.insert
		[/insert_tag]
		[option]
			message="&"+x.png+"="+_ "(Cancel)"
		[/option]
	[/message]
	{IF_VAR menu.level equals 1 (
		[then]
			{WBD_INVENTORY_CANCEL_STACK_PUSH (_ "give items")}
		[/then]
		[else]
			{VARIABLE menu.action_flag 2}
		[/else]
	)}
	[while]
		[variable]
			name=menu.level
			equals=1
		[/variable]
		[do]
			{CLEAR_VARIABLE menu.insert}
			{VARIABLE unit_path current.adjacent[$menu.recipient]}
			{WBD_FOR_DROPPABLE current.unit weapons.melee (
				[calculate_weapon_display]
					unit_variable=current.adjacent[$menu.recipient]
					weapon_variable=current.unit.variables.inventory.weapons.melee[$i]
				[/calculate_weapon_display]
				[set_variables]
					name=menu.insert
					mode=append
					[value]
						{WBD_DISPLAY_WEAPON current.unit.variables.inventory.weapons.melee[$i] $display_damage| $display_number|}
						[command]
							[set_variables]
								name=current.adjacent[$menu.recipient].variables.inventory.weapons.melee
								mode=append
								to_variable=current.unit.variables.inventory.weapons.melee[$i]
							[/set_variables]
							{CLEAR_VARIABLE current.unit.variables.inventory.weapons.melee[$i]}
							{IF_VAR current.unit.variables.equipment_slots.melee_1 greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.melee_1 sub 1}
								[/then]
							)}
							{IF_VAR current.unit.variables.equipment_slots.melee_2 greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.melee_2 sub 1}
								[/then]
							)}
							{IF_VAR current.unit.variables.equipment_slots.melee_3 greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.melee_3 sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.primary equals $i (
								[then]
									{VARIABLE current.start_equip.primary -1}
								[/then]
							)}
							{IF_VAR current.start_equip.secondary equals $i (
								[then]
									{VARIABLE current.start_equip.secondary -1}
								[/then]
							)}
							{IF_VAR current.start_equip.tertiary equals $i (
								[then]
									{VARIABLE current.start_equip.tertiary -1}
								[/then]
							)}
							{IF_VAR current.start_equip.primary greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.primary sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.secondary greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.secondary sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.tertiary greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.tertiary sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			{VARIABLE unit_path current.adjacent[$menu.recipient]}
			{WBD_FOR_DROPPABLE current.unit weapons.ranged (
				[calculate_weapon_display]
					unit_variable=current.adjacent[$menu.recipient]
					weapon_variable=current.unit.variables.inventory.weapons.ranged[$i]
				[/calculate_weapon_display]
				[set_variables]
					name=menu.insert
					mode=append
					[value]
						{WBD_DISPLAY_WEAPON current.unit.variables.inventory.weapons.ranged[$i] $display_damage| $display_number|}
						[command]
							[set_variables]
								name=current.adjacent[$menu.recipient].variables.inventory.weapons.ranged
								mode=append
								to_variable=current.unit.variables.inventory.weapons.ranged[$i]
							[/set_variables]
							{CLEAR_VARIABLE current.unit.variables.inventory.weapons.ranged[$i]}
							{IF_VAR current.unit.variables.equipment_slots.ranged greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.ranged sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.ranged equals $i (
								[then]
									{VARIABLE current.start_equip.ranged -1}
								[/then]
							)}
							{IF_VAR current.start_equip.ranged greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.ranged sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			{WBD_FOR_DROPPABLE current.unit armor.shield (
				[set_variables]
					name=menu.insert
					mode=append
					[value]
						{DISPLAY_SHIELD current.unit.variables.inventory.armor.shield[$i]}
						[command]
							[set_variables]
								name=current.adjacent[$menu.recipient].variables.inventory.armor.shield
								mode=append
								to_variable=current.unit.variables.inventory.armor.shield[$i]
							[/set_variables]
							{CLEAR_VARIABLE current.unit.variables.inventory.armor.shield[$i]}
							{IF_VAR current.unit.variables.equipment_slots.shield greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.shield sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.shield equals $i (
								[then]
									{VARIABLE current.start_equip.shield -1}
								[/then]
							)}
							{IF_VAR current.start_equip.shield greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.shield sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			{WBD_FOR_DROPPABLE current.unit armor.head (
				[set_variables]
					name=menu.insert
					mode=append
					[value]
						{DISPLAY_HEAD_ARMOR current.unit.variables.inventory.armor.head[$i]}
						[command]
							[set_variables]
								name=current.adjacent[$menu.recipient].variables.inventory.armor.head
								mode=append
								to_variable=current.unit.variables.inventory.armor.head[$i]
							[/set_variables]
							{CLEAR_VARIABLE current.unit.variables.inventory.armor.head[$i]}
							{IF_VAR current.unit.variables.equipment_slots.head_armor greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.head_armor sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.head equals $i (
								[then]
									{VARIABLE current.start_equip.head -1}
								[/then]
							)}
							{IF_VAR current.start_equip.head greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.head sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			{WBD_FOR_DROPPABLE current.unit armor.torso (
				[set_variables]
					name=menu.insert
					mode=append
					[value]
						{DISPLAY_TORSO_ARMOR current.unit.variables.inventory.armor.torso[$i]}
						[command]
							[set_variables]
								name=current.adjacent[$menu.recipient].variables.inventory.armor.torso
								mode=append
								to_variable=current.unit.variables.inventory.armor.torso[$i]
							[/set_variables]
							{CLEAR_VARIABLE current.unit.variables.inventory.armor.torso[$i]}
							{IF_VAR current.unit.variables.equipment_slots.torso_armor greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.torso_armor sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.torso equals $i (
								[then]
									{VARIABLE current.start_equip.torso -1}
								[/then]
							)}
							{IF_VAR current.start_equip.torso greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.torso sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			{WBD_FOR_DROPPABLE current.unit armor.legs (
				[set_variables]
					name=menu.insert
					mode=append
					[value]
						{DISPLAY_LEGS_ARMOR current.unit.variables.inventory.armor.legs[$i]}
						[command]
							[set_variables]
								name=current.adjacent[$menu.recipient].variables.inventory.armor.legs
								mode=append
								to_variable=current.unit.variables.inventory.armor.legs[$i]
							[/set_variables]
							{CLEAR_VARIABLE current.unit.variables.inventory.armor.legs[$i]}
							{IF_VAR current.unit.variables.equipment_slots.leg_armor greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.leg_armor sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.legs equals $i (
								[then]
									{VARIABLE current.start_equip.legs -1}
								[/then]
							)}
							{IF_VAR current.start_equip.legs greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.legs sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			{WBD_FOR_DROPPABLE current.unit usables (
				[set_variables]
					name=menu.insert
					mode=append
					[value]
						message="&"+$current.unit.variables.inventory.usables[$i].icon|.png+"="+_ "$current.unit.variables.inventory.usables[$i].description"
						[command]
							[set_variables]
								name=current.adjacent[$menu.recipient].variables.inventory.usables
								mode=append
								to_variable=current.unit.variables.inventory.usables[$i]
							[/set_variables]
							{CLEAR_VARIABLE current.unit.variables.inventory.usables[$i]}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			[message]
				speaker=narrator
				side_for=$side_number
				[option]
					message="&"+check.png+"="+_ "(End)"
					[command]
						[unstore_unit]
							variable=current.adjacent[$menu.recipient]
						[/unstore_unit]
						[unstore_unit]
							variable=current.unit
						[/unstore_unit]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					message="&"+icons/gold-give.png+"="+ _ "Transfer gold"
					[show_if]
						[variable]
							name=current.unit.variables.personal_gold
							greater_than=0
						[/variable]
						[and]
							[variable]
								name=current.adjacent[$menu.recipient].canrecruit
								equals=yes
							[/variable]
						[/and]
					[/show_if]
					[command]
						{VARIABLE menu.header_message (_ "Transfer how much gold?")}
						{VARIABLE menu.accept_message ("&"+check.png+"="+_ "(Transfer gold)")}
						{VARIABLE menu.cancel_message (_ "&"+x.png+"="+_ "(Cancel gold transfer)")}
						{FIRE_EVENT "wbd gold input"}
						{IF_VAR menu.gold.amount greater_than 0 (
							[then]
								{VARIABLE_OP current.unit.variables.personal_gold sub $menu.gold.amount}
								{VARIABLE_OP current.adjacent[$menu.recipient].variables.personal_gold add $menu.gold.amount}
								[modify_side]
									side=$current.unit.side
									gold=$current.unit.variables.personal_gold
								[/modify_side]
								[modify_side]
									side=$current.adjacent[$menu.recipient].side
									gold=$current.adjacent[$menu.recipient].variables.personal_gold
								[/modify_side]
								[sound]
									name=gold.ogg
								[/sound]
								{VARIABLE menu.action_flag 1}
							[/then]
						)}
					[/command]
				[/option]
				[option]
					message="&"+x.png+"="+_ "(Cancel)"
					[command]
						{CLEAR_VARIABLE menu.action_flag}
						{VARIABLE menu.level 0}
					[/command]
				[/option]
			[/message]
		[/do]
	[/while]
	[switch]
		variable=menu.action_flag
		[case]
			value=1
			{IF_VAR current.action.expended less_than 2 (
				[then]
					{VARIABLE current.action.expended 1}
				[/then]
				[else]
					{VARIABLE current.action.expended 3}
				[/else]
			)}
			{CLEAR_VARIABLE menu.action_flag}
		[/case]
		[case]
			value=2
			{CLEAR_VARIABLE menu.action_flag}
		[/case]
		[else]
			{WBD_INVENTORY_CANCEL_STACK_POP}
		[/else]
	[/switch]
[/event]

[event]
	name=wbd drop items
	first_time_only=no

	{WBD_INVENTORY_CANCEL_STACK_PUSH (_ "drop items")}
	{VARIABLE menu.level 1}
	[while]
		[variable]
			name=menu.level
			equals=1
		[/variable]
		[do]
			{CLEAR_VARIABLE menu.insert}
			{VARIABLE unit_path current.unit}
			{WBD_FOR_DROPPABLE current.unit weapons.melee (
				[calculate_weapon_display]
					unit_variable=current.unit
					weapon_variable=current.unit.variables.inventory.weapons.melee[$i]
				[/calculate_weapon_display]
				[set_variables]
					name=menu.insert
					mode=append
					[value]
						{WBD_DISPLAY_WEAPON current.unit.variables.inventory.weapons.melee[$i] $display_damage| $display_number|}
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.weapons.melee[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.weapons.melee[$i]}
							{IF_VAR current.unit.variables.equipment_slots.melee_1 greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.melee_1 sub 1}
								[/then]
							)}
							{IF_VAR current.unit.variables.equipment_slots.melee_2 greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.melee_2 sub 1}
								[/then]
							)}
							{IF_VAR current.unit.variables.equipment_slots.melee_3 greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.melee_3 sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.primary equals $i (
								[then]
									{VARIABLE current.start_equip.primary -1}
								[/then]
							)}
							{IF_VAR current.start_equip.secondary equals $i (
								[then]
									{VARIABLE current.start_equip.secondary -1}
								[/then]
							)}
							{IF_VAR current.start_equip.tertiary equals $i (
								[then]
									{VARIABLE current.start_equip.tertiary -1}
								[/then]
							)}
							{IF_VAR current.start_equip.primary greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.primary sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.secondary greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.secondary sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.tertiary greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.tertiary sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			{VARIABLE unit_path current.unit}
			{WBD_FOR_DROPPABLE current.unit weapons.ranged (
				[calculate_weapon_display]
					unit_variable=current.unit
					weapon_variable=current.unit.variables.inventory.weapons.ranged[$i]
				[/calculate_weapon_display]
				[set_variables]
					name=menu.insert
					mode=append
					[value]
						{WBD_DISPLAY_WEAPON current.unit.variables.inventory.weapons.ranged[$i] $display_damage| $display_number|}
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.weapons.ranged[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.weapons.ranged[$i]}
							{IF_VAR current.unit.variables.equipment_slots.ranged greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.ranged sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.ranged equals $i (
								[then]
									{VARIABLE current.start_equip.ranged -1}
								[/then]
							)}
							{IF_VAR current.start_equip.ranged greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.ranged sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			{WBD_FOR_DROPPABLE current.unit armor.shield (
				[set_variables]
					name=menu.insert
					mode=append
					[value]
						{DISPLAY_SHIELD current.unit.variables.inventory.armor.shield[$i]}
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.armor.shield[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.armor.shield[$i]}
							{IF_VAR current.unit.variables.equipment_slots.shield greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.shield sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.shield equals $i (
								[then]
									{VARIABLE current.start_equip.shield -1}
								[/then]
							)}
							{IF_VAR current.start_equip.shield greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.shield sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			{WBD_FOR_DROPPABLE current.unit armor.head (
				[set_variables]
					name=menu.insert
					mode=append
					[value]
						{DISPLAY_HEAD_ARMOR current.unit.variables.inventory.armor.head[$i]}
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.armor.head[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.armor.head[$i]}
							{IF_VAR current.unit.variables.equipment_slots.head_armor greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.head_armor sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.head equals $i (
								[then]
									{VARIABLE current.start_equip.head -1}
								[/then]
							)}
							{IF_VAR current.start_equip.head greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.head sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			{WBD_FOR_DROPPABLE current.unit armor.torso (
				[set_variables]
					name=menu.insert
					mode=append
					[value]
						{DISPLAY_TORSO_ARMOR current.unit.variables.inventory.armor.torso[$i]}
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.armor.torso[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.armor.torso[$i]}
							{IF_VAR current.unit.variables.equipment_slots.torso_armor greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.torso_armor sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.torso equals $i (
								[then]
									{VARIABLE current.start_equip.torso -1}
								[/then]
							)}
							{IF_VAR current.start_equip.torso greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.torso sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			{WBD_FOR_DROPPABLE current.unit armor.legs (
				[set_variables]
					name=menu.insert
					mode=append
					[value]
						{DISPLAY_LEGS_ARMOR current.unit.variables.inventory.armor.legs[$i]}
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.armor.legs[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.armor.legs[$i]}
							{IF_VAR current.unit.variables.equipment_slots.leg_armor greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.leg_armor sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.legs equals $i (
								[then]
									{VARIABLE current.start_equip.legs -1}
								[/then]
							)}
							{IF_VAR current.start_equip.legs greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.legs sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			{WBD_FOR_DROPPABLE current.unit usables (
				[set_variables]
					name=menu.insert
					mode=append
					[value]
						message="&"+$current.unit.variables.inventory.usables[$i].icon|.png+"="+_ "$current.unit.variables.inventory.usables[$i].description"
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.usables[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.usables[$i]}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			[message]
				speaker=narrator
				side_for=$side_number
				[option]
					message="&"+check.png+"="+_ "(End)"
					[command]
						[unstore_unit]
							variable=current.unit
						[/unstore_unit]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					message="&"+icons/gold-give.png+"="+ _ "Drop gold"
					[show_if]
						[variable]
							name=current.unit.variables.personal_gold
							greater_than=0
						[/variable]
					[/show_if]
					[command]
						{VARIABLE menu.header_message (_ "Drop how much gold?")}
						{VARIABLE menu.accept_message ("&"+check.png+"="+_ "(Drop gold)")}
						{VARIABLE menu.cancel_message (_ "&"+x.png+"="+_ "(Cancel gold drop)")}
						{FIRE_EVENT "wbd gold input"}
						{IF_VAR menu.gold.amount greater_than 0 (
							[then]
								{VARIABLE_OP current.unit.variables.personal_gold sub $menu.gold.amount}
								[modify_side]
									side=$current.unit.side
									gold=$current.unit.variables.personal_gold
								[/modify_side]
								{DROP_GOLD menu.gold.amount $menu.location.x| $menu.location.y|}
								[sound]
									name=gold.ogg
								[/sound]
								{VARIABLE menu.action_flag 1}
							[/then]
						)}
					[/command]
				[/option]
				[option]
					message="&"+x.png+"="+_ "(Cancel)"
					[command]
						{CLEAR_VARIABLE menu.action_flag}
						{VARIABLE menu.level 0}
					[/command]
				[/option]
			[/message]
		[/do]
	[/while]
	{IF_VAR menu.action_flag equals 1 (
		[then]
			{IF_VAR current.action.expended less_than 2 (
				[then]
					{VARIABLE current.action.expended 1}
				[/then]
				[else]
					{VARIABLE current.action.expended 3}
				[/else]
			)}
			{CLEAR_VARIABLE menu.action_flag}
		[/then]
		[else]
			{WBD_INVENTORY_CANCEL_STACK_POP}
		[/else]
	)}
[/event]

[event]
	name=wbd gold input
	first_time_only=no

	{VARIABLE menu.gold.amount 0}
	{VARIABLE menu.level 2}
	[while]
		[variable]
			name=menu.level
			equals=2
		[/variable]
		[do]
			{VARIABLE menu.gold.shifted_difference "$(10*0$menu.gold.amount-0$current.unit.variables.personal_gold)"}
			[message]
				speaker=narrator
				message="$menu.header_message| $menu.gold.amount|_"
				side_for=$side_number
				[option]
					message=$menu.accept_message
					[show_if]
						[variable]
							name=menu.gold.amount
							greater_than=0
						[/variable]
					[/show_if]
					[command]
						{VARIABLE menu.level 1}
					[/command]
				[/option]
				[option]
					message="0"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=1
						[/variable]
						[and]
							[variable]
								name=menu.gold.amount
								greater_than=0
							[/variable]
						[/and]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
					[/command]
				[/option]
				[option]
					message="1"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=0
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 1}
					[/command]
				[/option]
				[option]
					message="2"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=-1
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 2}
					[/command]
				[/option]
				[option]
					message="3"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=-2
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 3}
					[/command]
				[/option]
				[option]
					message="4"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=-3
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 4}
					[/command]
				[/option]
				[option]
					message="5"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=-4
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 5}
					[/command]
				[/option]
				[option]
					message="6"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=-5
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 6}
					[/command]
				[/option]
				[option]
					message="7"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=-6
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 7}
					[/command]
				[/option]
				[option]
					message="8"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=-7
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 8}
					[/command]
				[/option]
				[option]
					message="9"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=-8
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 9}
					[/command]
				[/option]
				[option]
					message=$menu.cancel_message
					[command]
						{VARIABLE menu.gold.amount 0}
						{VARIABLE menu.level 1}
					[/command]
				[/option]
			[/message]
		[/do]
	[/while]
[/event]

[event]
	name=wbd inventory cancel stack pop
	first_time_only=no

	[set_variables]
		name=current
		mode=replace
		to_variable=cancel[$menu.cancel_ptr]
	[/set_variables]
	{CLEAR_VARIABLE cancel[$menu.cancel_ptr]}
	{VARIABLE_OP menu.cancel_ptr sub 1}
	[construct_unit]
		variable=current.unit
	[/construct_unit]
	{IF_VAR menu.construct_type equals pc (
		[then]
			[modify_side]
				side=$side_number
				gold=$current.unit.variables.personal_gold
			[/modify_side]
		[/then]
		[else]
			[unstore_unit]
				variable=current.leader
			[/unstore_unit]
			[modify_side]
				side=$side_number
				gold=$current.leader.variables.personal_gold
			[/modify_side]
		[/else]
	)}
	{FOREACH current.adjacent i}
		[unstore_unit]
			variable=current.adjacent[$i]
		[/unstore_unit]
		{IF_VAR current.adjacent[$i].canrecruit equals yes (
			[then]
				[modify_side]
					side=$current.adjacent[$i].side
					gold=$current.adjacent[$i].variables.personal_gold
				[/modify_side]
			[/then]
		)}
	{NEXT i}
	[item_cleanup]
		x=$menu.location.x
		y=$menu.location.y
	[/item_cleanup]
	{FOREACH current.ground i}
		[drop_item]
			x=$menu.location.x
			y=$menu.location.y
			from_variable=current.ground[$i]
		[/drop_item]
	{NEXT i}
[/event]

[event]
	name=wbd inventory cancel stack push
	first_time_only=no

	{VARIABLE_OP menu.cancel_ptr add 1}
	[set_variables]
		name=current.ground
		mode=replace
		to_variable=ground.x$menu.location.x|.y$menu.location.y|.items
	[/set_variables]
	[store_unit]
		variable=current.unit
		[filter]
			x=$menu.location.x
			y=$menu.location.y
		[/filter]
	[/store_unit]
	[store_unit]
		variable=current.adjacent
		[filter]
			side=$const.player_sides
			[not]
				type="WBD Unknown Adventurer"
			[/not]
			[filter_adjacent]
				id=$current.unit.id
			[/filter_adjacent]
			[and]
				canrecruit=yes
				[or]
					[not]
						race=undead
					[/not]
				[/or]
				[or]
					[filter_wml]
						corpse_type=skel
					[/filter_wml]
				[/or]
				[or]
					[filter_wml]
						[variables]
							[abilities]
								skeletal=1
							[/abilities]
						[/variables]
					[/filter_wml]
				[/or]
			[/and]
		[/filter]
	[/store_unit]
	{IF_VAR menu.construct_type equals npc (
		[then]
			[store_unit]
				variable=current.leader
				[filter]
					side=$side_number
					canrecruit=yes
				[/filter]
			[/store_unit]
		[/then]
	)}
	[set_variables]
		name=cancel
		mode=append
		to_variable=current
	[/set_variables]
[/event]