#in game shops/stores

#define RED_COST PATH
{CLEAR_VARIABLE red_cost}
{CLEAR_VARIABLE red_cost2}
[if]
	[variable]
		name={PATH}
		greater_than=$current_unit.variables.personal_gold
	[/variable]
	[then]
		{VARIABLE red_cost "<span foreground='red'>"}
		{VARIABLE red_cost2 "</span>"}
	[/then]
[/if]
#enddef

#define CREATE_WEAPON_INSERT_TO_SHOP
    {RANDOM 0..3}
    [if]
        [variable]
            name=random
            numerical_equals=0
        [/variable]
        [then]
            {VARIABLE_OP new_weapon_rank rand 0..$dungeon_level.max}
        [/then]
        [else]
            {VARIABLE level_minus_3 $dungeon_level.max}
            {VARIABLE_OP level_minus_3 sub 3}
            [if]
                [variable]
                    name=level_minus_3
                    less_than=0
                [/variable]
                [then]
                    {VARIABLE level_minus_3 0}
                [/then]
            [/if]
            {VARIABLE_OP new_weapon_rank rand $level_minus_3..$dungeon_level.max}
        [/else]
    [/if]
    {RANDOM 0..2}
    {VARIABLE_OP new_weapon_rank add $random}
	{RANDOM_WEAPON prob_overworld_shop_weapon $new_weapon_rank random new_weapon}

    [if]
        [variable]
            name=new_weapon.category
            equals=melee_weapon
        [/variable]
        [then]
            [set_variables]
                name=weapon_shop.weapons.melee
                mode=append
                [insert_tag]
                    name=value
                    variable=new_weapon
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]
    [if]
        [variable]
            name=new_weapon.category
            equals=ranged_weapon
        [/variable]
        [then]
            [set_variables]
                name=weapon_shop.weapons.ranged
                mode=append
                [insert_tag]
                    name=value
                    variable=new_weapon
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]
#enddef

#define CREATE_ARMOR_INSERT_TO_SHOP
    {RANDOM 0..3}
    [if]
        [variable]
            name=random
            numerical_equals=0
        [/variable]
        [then]
            {VARIABLE_OP new_armor_rank rand 0..$dungeon_level.max}
        [/then]
        [else]
            {VARIABLE level_minus_3 $dungeon_level.max}
            {VARIABLE_OP level_minus_3 add  -3}
            [if]
                [variable]
                    name=level_minus_3
                    less_than=0
                [/variable]
                [then]
                    {VARIABLE level_minus_3 0}
                [/then]
            [/if]
            {VARIABLE_OP new_armor_rank rand $level_minus_3..$dungeon_level.max}
        [/else]
    [/if]
    {RANDOM 0..2}
    {VARIABLE_OP new_armor_rank add $random}
	{RANDOM_ARMOR prob_overworld_shop_armor $new_armor_rank random new_armor}
	
    [if]
        [variable]
            name=new_armor.category
            equals=torso_armor
        [/variable]
        [then]
            [set_variables]
                name=armor_shop.armor.torso
                mode=append
                [insert_tag]
                    name=value
                    variable=new_armor
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]
    [if]
        [variable]
            name=new_armor.category
            equals=legs_armor
        [/variable]
        [then]
            [set_variables]
                name=armor_shop.armor.legs
                mode=append
                [insert_tag]
                    name=value
                    variable=new_armor
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]
    [if]
        [variable]
            name=new_armor.category
            equals=head_armor
        [/variable]
        [then]
            [set_variables]
                name=armor_shop.armor.head
                mode=append
                [insert_tag]
                    name=value
                    variable=new_armor
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]
    [if]
        [variable]
            name=new_armor.category
            equals=shield
        [/variable]
        [then]
            [set_variables]
                name=armor_shop.armor.shield
                mode=append
                [insert_tag]
                    name=value
                    variable=new_armor
                [/insert_tag]
            [/set_variables]
        [/then]
    [/if]
#enddef

#define WESBAND_WEAPON_SHOP
    [set_menu_item]
        id=a_wesband_weapon_shop
		image=commands/button_village.png
        description=_ "Enter shop"
        [filter_location]
            x,y=$weapon_shop_loc_x,$weapon_shop_loc_y
            [filter]
                side=$side_number
                canrecruit=yes
            [/filter]
        [/filter_location]
		[show_if]
		[/show_if]
        [command]
            [store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]
			{VARIABLE unit_path current_unit}
            {VARIABLE in_shop 1}
            [while]
                [variable]
                    name=in_shop
                    greater_than=0
                [/variable]
                [do]
					[modify_side]
						side=$current_unit.side
						gold=$current_unit.variables.personal_gold
					[/modify_side]
                    {CLEAR_VARIABLE shop_item_insert_melee}
                    {FOREACH weapon_shop.weapons.melee i}
                        [calculate_weapon_display]
							unit_variable=current_unit
							weapon_variable=weapon_shop.weapons.melee[$i]
						[/calculate_weapon_display]
						{RED_COST "weapon_shop.weapons.melee[$i].absolute_value"}
                        [set_variables]
                            name=shop_item_insert_melee
                            mode=append
                            [value]
								{DISPLAY_WEAPON (weapon_shop.weapons.melee[$i])}="$red_cost|$weapon_shop.weapons.melee[$i].absolute_value|$red_cost2|"	
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.variables.personal_gold
                                            less_than=$weapon_shop.weapons.melee[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
											[set_prob]
												name=prob_overworld_shop_weapon
												op=scale
												item=$weapon_shop.weapons.melee[$i].prob_name
												weight=110
											[/set_prob]
                                            {VARIABLE_OP current_unit.variables.personal_gold sub $weapon_shop.weapons.melee[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.weapons.melee
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=weapon_shop.weapons.melee[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "weapon_shop.weapons.melee[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_melee.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_melee
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]

                    {CLEAR_VARIABLE shop_item_insert_ranged}
                    {FOREACH weapon_shop.weapons.ranged i}
                        [calculate_weapon_display]
							unit_variable=current_unit
							weapon_variable=weapon_shop.weapons.ranged[$i]
						[/calculate_weapon_display]
						{RED_COST "weapon_shop.weapons.ranged[$i].absolute_value"}
                        [set_variables]
                            name=shop_item_insert_ranged
                            mode=append
                            [value]
								{DISPLAY_WEAPON (weapon_shop.weapons.ranged[$i])}="$red_cost|$weapon_shop.weapons.ranged[$i].absolute_value|$red_cost2|"		
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.variables.personal_gold
                                            less_than=$weapon_shop.weapons.ranged[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
											[set_prob]
												name=prob_overworld_shop_weapon
												op=scale
												item=$weapon_shop.weapons.ranged[$i].prob_name
												weight=110
											[/set_prob]
                                            {VARIABLE_OP current_unit.variables.personal_gold sub $weapon_shop.weapons.ranged[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.weapons.ranged
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=weapon_shop.weapons.ranged[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "weapon_shop.weapons.ranged[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_ranged.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_ranged
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]

                    #{VARIABLE creation_gold $current_unit.variables.personal_gold} want to be side gold to personal_golde
                    [message]
                        image=$shop_names.weapon3
						speaker=narrator
                        message= _ "Welcome to $shop_names.weapon|'s $shop_names.weapon2|. Be sure to check back later, as I frequently get new stock.

<small>You have $current_unit.variables.personal_gold| gold to spend. Which item will you buy?</small>"
                        [option]
                            message ="&"+check.png+"="+_ "End purchase."
                            [command]
                                [unstore_unit]
                                    variable=current_unit
                                [/unstore_unit]
                                [modify_side]
                                    side=$current_unit.side
                                    gold=$current_unit.variables.personal_gold
                                [/modify_side]
                                {VARIABLE in_shop 0}
                            [/command]
                        [/option]
                        [option]
                            message ="&"+check.png+"="+_ "Sell to store."
                            [command]
                                {VARIABLE in_shop 2}
                                [while]
                                    [variable]
                                        name=in_shop
                                        greater_than=1
                                    [/variable]
                                    [do]
										[modify_side]
											side=$current_unit.side
											gold=$current_unit.variables.personal_gold
										[/modify_side]
                                        {CLEAR_VARIABLE sell_item_insert}
                                        {FOREACH current_unit.variables.inventory.weapons.melee i}
                                            [if]
                                                [variable]
                                                    name=current_unit.variables.equipment_slots.melee_1
                                                    numerical_equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.variables.equipment_slots.melee_2
                                                        numerical_equals=$i
                                                    [/variable]
                                                    [or]
                                                        [variable]
                                                            name=current_unit.variables.equipment_slots.melee_3
                                                            numerical_equals=$i
                                                        [/variable]
                                                        [or]
                                                            [variable]
                                                                name=current_unit.variables.inventory.weapons.melee[$i].undroppable
                                                                numerical_equals=1
                                                            [/variable]
                                                        [/or]
                                                    [/or]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.variables.inventory.weapons.melee[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .2}
                                                    {VARIABLE_OP temp_value round "floor"}
													{IF_VAR temp_value less_than 1 (
														[then]
															{VARIABLE temp_value 1}
														[/then]
													)}
													{VARIABLE temp_i_$i| $i}
													[calculate_weapon_display]
														unit_variable=current_unit
														weapon_variable=current_unit.variables.inventory.weapons.melee[$i]
													[/calculate_weapon_display]
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
															{DISPLAY_WEAPON (current_unit.variables.inventory.weapons.melee[$i])}="$temp_value"		
                                                            [command]
                                                                {VARIABLE_OP current_unit.variables.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=weapon_shop.weapons.melee
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.variables.inventory.weapons.melee[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
																[clear_variable]
                                                                    name=current_unit.variables.inventory.weapons.melee[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=temp_i_$i
                                                                        less_than=$current_unit.variables.equipment_slots.melee_1
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.variables.equipment_slots.melee_1 sub 1}
                                                                    [/then]
                                                                [/if]
                                                                [if]
                                                                    [variable]
                                                                        name=temp_i_$i
                                                                        less_than=$current_unit.variables.equipment_slots.melee_2
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.variables.equipment_slots.melee_2 sub 1}
                                                                    [/then]
                                                                [/if]
                                                                [if]
                                                                    [variable]
                                                                        name=temp_i_$i
                                                                        less_than=$current_unit.variables.equipment_slots.melee_3
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.variables.equipment_slots.melee_3 sub 1}
                                                                    [/then]
                                                                [/if]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
                                        {FOREACH current_unit.variables.inventory.weapons.ranged i}
                                            [if]
                                                [variable]
                                                    name=current_unit.variables.equipment_slots.ranged
                                                    numerical_equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.variables.inventory.weapons.ranged[$i].undroppable
                                                        numerical_equals=1
                                                    [/variable]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.variables.inventory.weapons.ranged[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .2}
                                                    {VARIABLE_OP temp_value round "floor"}
													{IF_VAR temp_value less_than 1 (
														[then]
															{VARIABLE temp_value 1}
														[/then]
													)}
													{VARIABLE temp_i_$i| $i}
													[calculate_weapon_display]
														unit_variable=current_unit
														weapon_variable=current_unit.variables.inventory.weapons.ranged[$i]
													[/calculate_weapon_display]
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
															{DISPLAY_WEAPON (current_unit.variables.inventory.weapons.ranged[$i])}="$temp_value"		
                                                            [command]
                                                                {VARIABLE_OP current_unit.variables.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=weapon_shop.weapons.ranged
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.variables.inventory.weapons.ranged[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
                                                                [clear_variable]
                                                                    name=current_unit.variables.inventory.weapons.ranged[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=temp_i_$i
                                                                        less_than=$current_unit.variables.equipment_slots.ranged
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.variables.equipment_slots.ranged sub 1}
                                                                    [/then]
                                                                [/if]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
                                        [if]
                                            [variable]
                                                name=sell_item_insert.length
                                                less_than=1
                                            [/variable]
                                            [then]
                                                [message]
                                                    speaker=narrator
                                                    message=_ "You have no items to sell."
                                                    image=wesnoth-icon.png
													side_for=$current_unit.side
                                                [/message]
                                                {VARIABLE in_shop 1}
                                            [/then]
                                            [else]
                                                [message]
                                                    speaker=narrator
                                                    message= _ "Sell which item?"
                                                    [option]
                                                        message ="&"+check.png+"="+_ "End selling."
                                                        [command]
                                                            [modify_side]
                                                                side=$current_unit.side
                                                                gold=$current_unit.variables.personal_gold
                                                            [/modify_side]
                                                            {VARIABLE in_shop 1}
                                                        [/command]
                                                    [/option]
                                                    [insert_tag]
                                                        name=option
                                                        variable=sell_item_insert
                                                    [/insert_tag]
                                                    image=wesnoth-icon.png
                                                [/message]
                                            [/else]
                                        [/if]
                                    [/do]
                                [/while]
                            [/command]
                        [/option]
                        {SHOP_DIVIDER_MELEE_WEAPONS}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_melee
                        [/insert_tag]
                        {SHOP_DIVIDER_RANGED_WEAPONS}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_ranged
                        [/insert_tag]
                    [/message]
                [/do]
            [/while]
        [/command]
    [/set_menu_item]
#enddef

#define WESBAND_ARMOR_SHOP
    [set_menu_item]
        id=a_wesband_armor_shop
		image=commands/button_village.png
        description=_ "Enter shop"
        [filter_location]
            x,y=$armor_shop_loc_x,$armor_shop_loc_y
            [filter]
                side=$side_number
                canrecruit=yes
            [/filter]
        [/filter_location]
		[show_if]
		[/show_if]
        [command]
            [store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]
            {VARIABLE in_shop 1}
            [while]
                [variable]
                    name=in_shop
                    greater_than=0
                [/variable]
                [do]
					[modify_side]
						side=$current_unit.side
						gold=$current_unit.variables.personal_gold
					[/modify_side]
                    {CLEAR_VARIABLE shop_item_insert_torso}
                    {FOREACH armor_shop.armor.torso i}
						{RED_COST "armor_shop.armor.torso[$i].absolute_value"}
                        [set_variables]
                            name=shop_item_insert_torso
                            mode=append
                            [value]
                                {DISPLAY_TORSO_ARMOR (armor_shop.armor.torso[$i])}="$red_cost|$armor_shop.armor.torso[$i].absolute_value|$red_cost2|"	
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.variables.personal_gold
                                            less_than=$armor_shop.armor.torso[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
											[set_prob]
												name=prob_overworld_shop_armor
												op=scale
												item=$armor_shop.armor.torso[$i].prob_name
												weight=110
											[/set_prob]
                                            {VARIABLE_OP current_unit.variables.personal_gold sub $armor_shop.armor.torso[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.armor.torso
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=armor_shop.armor.torso[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "armor_shop.armor.torso[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_torso.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_torso
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]

                    {CLEAR_VARIABLE shop_item_insert_legs}
                    {FOREACH armor_shop.armor.legs i}
						{RED_COST "armor_shop.armor.legs[$i].absolute_value"}
                        [set_variables]
                            name=shop_item_insert_legs
                            mode=append
                            [value]
								{DISPLAY_LEGS_ARMOR (armor_shop.armor.legs[$i])}="$red_cost|$armor_shop.armor.legs[$i].absolute_value|$red_cost2|"
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.variables.personal_gold
                                            less_than=$armor_shop.armor.legs[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
											[set_prob]
												name=prob_overworld_shop_armor
												op=scale
												item=$armor_shop.armor.legs[$i].prob_name
												weight=110
											[/set_prob]
                                            {VARIABLE_OP current_unit.variables.personal_gold sub $armor_shop.armor.legs[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.armor.legs
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=armor_shop.armor.legs[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "armor_shop.armor.legs[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_legs.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_legs
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]

                    {CLEAR_VARIABLE shop_item_insert_head}
                    {FOREACH armor_shop.armor.head i}
						{RED_COST "armor_shop.armor.head[$i].absolute_value"}
                        [set_variables]
                            name=shop_item_insert_head
                            mode=append
                            [value]
								{DISPLAY_HEAD_ARMOR (armor_shop.armor.head[$i])}="$red_cost|$armor_shop.armor.head[$i].absolute_value|$red_cost2|"
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.variables.personal_gold
                                            less_than=$armor_shop.armor.head[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
											[set_prob]
												name=prob_overworld_shop_armor
												op=scale
												item=$armor_shop.armor.head[$i].prob_name
												weight=110
											[/set_prob]
                                            {VARIABLE_OP current_unit.variables.personal_gold sub $armor_shop.armor.head[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.armor.head
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=armor_shop.armor.head[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "armor_shop.armor.head[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_head.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_head
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]

                    {CLEAR_VARIABLE shop_item_insert_shield}
                    {FOREACH armor_shop.armor.shield i}
						{RED_COST "armor_shop.armor.shield[$i].absolute_value"}
                        [set_variables]
                            name=shop_item_insert_shield
                            mode=append
                            [value]
								{DISPLAY_SHIELD (armor_shop.armor.shield[$i])}="$red_cost|$armor_shop.armor.shield[$i].absolute_value|$red_cost2|"									
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.variables.personal_gold
                                            less_than=$armor_shop.armor.shield[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
											[set_prob]
												name=prob_overworld_shop_armor
												op=scale
												item=$armor_shop.armor.shield[$i].prob_name
												weight=110
											[/set_prob]
                                            {VARIABLE_OP current_unit.variables.personal_gold sub $armor_shop.armor.shield[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.armor.shield
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=armor_shop.armor.shield[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "armor_shop.armor.shield[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_shield.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_shield
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]

                    #{VARIABLE creation_gold $current_unit.variables.personal_gold} want to be side gold to personal_golde
                    [message]
                        image=$shop_names.armor3
						speaker=narrator
                        message= _ "Welcome to $shop_names.armor|'s $shop_names.armor2|. Be sure to check back later, as I frequently get new stock.

<small>You have $current_unit.variables.personal_gold| gold to spend. Which item will you buy?</small>"
                        [option]
                            message ="&"+check.png+"="+_ "End purchase."
                            [command]
                                [unstore_unit]
                                    variable=current_unit
                                [/unstore_unit]
                                [modify_side]
                                    side=$current_unit.side
                                    gold=$current_unit.variables.personal_gold
                                [/modify_side]
                                {VARIABLE in_shop 0}
                            [/command]
                        [/option]
                        [option]
                            message ="&"+check.png+"="+_ "Sell to store."
                            [command]
                                {VARIABLE in_shop 2}
                                [while]
                                    [variable]
                                        name=in_shop
                                        greater_than=1
                                    [/variable]
                                    [do]
										[modify_side]
											side=$current_unit.side
											gold=$current_unit.variables.personal_gold
										[/modify_side]
                                        {CLEAR_VARIABLE sell_item_insert}
                                        {FOREACH current_unit.variables.inventory.armor.torso i}
                                            [if]
                                                [variable]
                                                    name=current_unit.variables.equipment_slots.torso_armor
                                                    numerical_equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.variables.inventory.armor.torso[$i].undroppable
                                                        numerical_equals=1
                                                    [/variable]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.variables.inventory.armor.torso[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .2}
                                                    {VARIABLE_OP temp_value round "floor"}
													{IF_VAR temp_value less_than 1 (
														[then]
															{VARIABLE temp_value 1}
														[/then]
													)}
													{VARIABLE temp_i_$i| $i}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
															{DISPLAY_TORSO_ARMOR (current_unit.variables.inventory.armor.torso[$i])}="$temp_value"	
                                                            [command]
                                                                {VARIABLE_OP current_unit.variables.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=armor_shop.armor.torso
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.variables.inventory.armor.torso[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
                                                                [clear_variable]
                                                                    name=current_unit.variables.inventory.armor.torso[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=temp_i_$i
                                                                        less_than=$current_unit.variables.equipment_slots.torso_armor
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.variables.equipment_slots.torso_armor sub 1}
                                                                    [/then]
                                                                [/if]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
                                        {FOREACH current_unit.variables.inventory.armor.head i}
                                            [if]
                                                [variable]
                                                    name=current_unit.variables.equipment_slots.head_armor
                                                    numerical_equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.variables.inventory.armor.head[$i].undroppable
                                                        numerical_equals=1
                                                    [/variable]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.variables.inventory.armor.head[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .2}
                                                    {VARIABLE_OP temp_value round "floor"}
													{IF_VAR temp_value less_than 1 (
														[then]
															{VARIABLE temp_value 1}
														[/then]
													)}
													{VARIABLE temp_i_$i| $i}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
															{DISPLAY_HEAD_ARMOR (current_unit.variables.inventory.armor.head[$i])}="$temp_value"
                                                            [command]
                                                                {VARIABLE_OP current_unit.variables.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=armor_shop.armor.head
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.variables.inventory.armor.head[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
                                                                [clear_variable]
                                                                    name=current_unit.variables.inventory.armor.head[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=temp_i_$i
                                                                        less_than=$current_unit.variables.equipment_slots.head_armor
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.variables.equipment_slots.head_armor sub 1}
                                                                    [/then]
                                                                [/if]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
                                        {FOREACH current_unit.variables.inventory.armor.shield i}
                                            [if]
                                                [variable]
                                                    name=current_unit.variables.equipment_slots.shield
                                                    numerical_equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.variables.inventory.armor.shield[$i].undroppable
                                                        numerical_equals=1
                                                    [/variable]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.variables.inventory.armor.shield[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .2}
                                                    {VARIABLE_OP temp_value round "floor"}
													{IF_VAR temp_value less_than 1 (
														[then]
															{VARIABLE temp_value 1}
														[/then]
													)}
													{VARIABLE temp_i_$i| $i}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
															{DISPLAY_SHIELD (current_unit.variables.inventory.armor.shield[$i])}="$temp_value"	
                                                            [command]
                                                                {VARIABLE_OP current_unit.variables.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=armor_shop.armor.shield
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.variables.inventory.armor.shield[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
                                                                [clear_variable]
                                                                    name=current_unit.variables.inventory.armor.shield[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=temp_i_$i
                                                                        less_than=$current_unit.variables.equipment_slots.shield
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.variables.equipment_slots.shield sub 1}
                                                                    [/then]
                                                                [/if]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
                                        {FOREACH current_unit.variables.inventory.armor.legs i}
                                            [if]
                                                [variable]
                                                    name=current_unit.variables.equipment_slots.leg_armor
                                                    numerical_equals=$i
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=current_unit.variables.inventory.armor.legs[$i].undroppable
                                                        numerical_equals=1
                                                    [/variable]
                                                [/or]
                                                [then]
                                                [/then]
                                                [else]
                                                    {VARIABLE temp_value $current_unit.variables.inventory.armor.legs[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .2}
                                                    {VARIABLE_OP temp_value round "floor"}
													{IF_VAR temp_value less_than 1 (
														[then]
															{VARIABLE temp_value 1}
														[/then]
													)}
													{VARIABLE temp_i_$i| $i}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
															{DISPLAY_LEGS_ARMOR (current_unit.variables.inventory.armor.legs[$i])}="$temp_value"				
                                                            [command]
                                                                {VARIABLE_OP current_unit.variables.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=armor_shop.armor.legs
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.variables.inventory.armor.legs[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
                                                                [clear_variable]
                                                                    name=current_unit.variables.inventory.armor.legs[$i]
                                                                [/clear_variable]
                                                                [if]
                                                                    [variable]
                                                                        name=temp_i_$i
                                                                        less_than=$current_unit.variables.equipment_slots.leg_armor
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP current_unit.variables.equipment_slots.leg_armor sub 1}
                                                                    [/then]
                                                                [/if]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/else]
                                            [/if]
                                        {NEXT i}
                                        [if]
                                            [variable]
                                                name=sell_item_insert.length
                                                less_than=1
                                            [/variable]
                                            [then]
                                                [message]
                                                    speaker=narrator
                                                    message=_ "You have no items to sell."
                                                    image=wesnoth-icon.png
													side_for=$current_unit.side
                                                [/message]
                                                {VARIABLE in_shop 1}
                                            [/then]
                                            [else]
                                                [message]
                                                    speaker=narrator
                                                    message= _ "Sell which item?"
                                                    [option]
                                                        message ="&"+check.png+"="+_ "End selling."
                                                        [command]
                                                            [modify_side]
                                                                side=$current_unit.side
                                                                gold=$current_unit.variables.personal_gold
                                                            [/modify_side]
                                                            {VARIABLE in_shop 1}
                                                        [/command]
                                                    [/option]
                                                    [insert_tag]
                                                        name=option
                                                        variable=sell_item_insert
                                                    [/insert_tag]
                                                    image=wesnoth-icon.png
                                                [/message]
                                            [/else]
                                        [/if]
                                    [/do]
                                [/while]
                            [/command]
                        [/option]
                        {SHOP_DIVIDER_TORSO_ARMOR}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_torso
                        [/insert_tag]
                        {SHOP_DIVIDER_LEG_ARMOR}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_legs
                        [/insert_tag]
                        {SHOP_DIVIDER_HEAD_ARMOR}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_head
                        [/insert_tag]
                        {SHOP_DIVIDER_SHIELDS}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_shield
                        [/insert_tag]
                    [/message]
                [/do]
            [/while]
        [/command]
    [/set_menu_item]
#enddef

#define WESBAND_MAGIC_SHOP
    [set_menu_item]
        id=a_wesband_magic_shop
		image=commands/button_village.png
        description=_ "Enter shop"
        [filter_location]
            x,y=$magic_shop_loc_x,$magic_shop_loc_y
            [filter]
                side=$side_number
                canrecruit=yes
            [/filter]
        [/filter_location]
		[show_if]
		[/show_if]
        [command]
            [store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]
			{VARIABLE unit_path current_unit}
            {VARIABLE in_shop 1}
            [while]
                [variable]
                    name=in_shop
                    greater_than=0
                [/variable]
                [do]
					[modify_side]
						side=$current_unit.side
						gold=$current_unit.variables.personal_gold
					[/modify_side]
                    {CLEAR_VARIABLE shop_item_insert_potions}
                    {FOREACH magic_shop.potions i}
						{RED_COST "magic_shop.potions[$i].absolute_value"}
                        [set_variables]
                            name=shop_item_insert_potions
                            mode=append
                            [value]
                                message="&"+$magic_shop.potions[$i].icon|.png+"="+_ "$magic_shop.potions[$i].description|"="$red_cost|$magic_shop.potions[$i].absolute_value|$red_cost2|"
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.variables.personal_gold
                                            less_than=$magic_shop.potions[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
											[set_prob]
												name=prob_overworld_shop_potion
												op=scale
												item=$magic_shop.potions[$i].prob_name
												weight=110
											[/set_prob]
                                            {VARIABLE_OP current_unit.variables.personal_gold sub $magic_shop.potions[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.usables
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=magic_shop.potions[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "magic_shop.potions[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_potions.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_potions
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]
					
					{CLEAR_VARIABLE shop_item_insert_scrolls}
                    {FOREACH magic_shop.scrolls i}
						{RED_COST "magic_shop.scrolls[$i].absolute_value"}
                        [set_variables]
                            name=shop_item_insert_scrolls
                            mode=append
                            [value]
                                message="&"+$magic_shop.scrolls[$i].icon|.png+"="+_ "$magic_shop.scrolls[$i].description|"="$red_cost|$magic_shop.scrolls[$i].absolute_value|$red_cost2|"
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.variables.personal_gold
                                            less_than=$magic_shop.scrolls[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
											[set_prob]
												name=prob_overworld_shop_scroll
												op=scale
												item=$magic_shop.scrolls[$i].prob_name
												weight=110
											[/set_prob]
                                            {VARIABLE_OP current_unit.variables.personal_gold sub $magic_shop.scrolls[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.usables
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=magic_shop.scrolls[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "magic_shop.scrolls[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_scrolls.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_scrolls
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]
					
                    {CLEAR_VARIABLE shop_item_insert_tomes}
                    {FOREACH magic_shop.tomes i}
                        [set_variables]
                            name=shop_item_insert_tomes
                            mode=append
                            [value]
                                message="&"+$magic_shop.tomes[$i].icon|.png+"="+_ "$magic_shop.tomes[$i].description|"="$magic_shop.tomes[$i].absolute_value"
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.variables.personal_gold
                                            less_than=$magic_shop.tomes[$i].absolute_value
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to purchase that!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
                                            {VARIABLE_OP current_unit.variables.personal_gold sub $magic_shop.tomes[$i].absolute_value}
                                            [set_variables]
                                                name=current_unit.variables.inventory.usables
                                                mode=append
                                                [insert_tag]
                                                    name=literal
                                                    variable=magic_shop.tomes[$i]
                                                [/insert_tag]
                                            [/set_variables]
                                            {CLEAR_VARIABLE "magic_shop.tomes[$i]"}
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=shop_item_insert_tomes.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_tomes
								mode=append
								[value]
									message="&"+misc/blank-hex.png+"="+_ " "=" "	
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]

                    #{VARIABLE creation_gold $current_unit.variables.personal_gold} want to be side gold to personal_golde
                    [message]
                        image=$shop_names.magic3
						speaker=narrator
                        message= _ "Welcome to $shop_names.magic|'s $shop_names.magic2|. Be sure to check back later, as I frequently get new stock.

<small>You have $current_unit.variables.personal_gold| gold to spend. Which item will you buy?</small>"
                        [option]
                            message ="&"+check.png+"="+_ "End purchase."
                            [command]
                                [unstore_unit]
                                    variable=current_unit
                                [/unstore_unit]
                                {CONSTRUCT_UNIT}
                                [modify_side]
                                    side=$current_unit.side
                                    gold=$current_unit.variables.personal_gold
                                [/modify_side]
                                {VARIABLE in_shop 0}
                            [/command]
                        [/option]
						[option]
                            message ="&"+check.png+"="+_ "Sell to store."
                            [command]
                                {VARIABLE in_shop 2}
                                [while]
                                    [variable]
                                        name=in_shop
                                        greater_than=1
                                    [/variable]
                                    [do]
										[modify_side]
											side=$current_unit.side
											gold=$current_unit.variables.personal_gold
										[/modify_side]
                                        {CLEAR_VARIABLE sell_item_insert}
                                        {FOREACH current_unit.variables.inventory.usables i}
                                            [if]
                                                [variable]
                                                    name=current_unit.variables.inventory.usables[$i].user_name
                                                    numerical_equals=potion
                                                [/variable]
												[or]
													[variable]
	                                                    name=current_unit.variables.inventory.usables[$i].user_name
	                                                    numerical_equals=scroll
	                                                [/variable]
												[/or]
                                                [then]
													{VARIABLE temp_value $current_unit.variables.inventory.usables[$i].absolute_value}
                                                    {VARIABLE_OP temp_value multiply .3}
                                                    {VARIABLE_OP temp_value round "floor"}
													{IF_VAR temp_value less_than 1 (
														[then]
															{VARIABLE temp_value 1}
														[/then]
													)}
                                                    [set_variables]
                                                        name=sell_item_insert
                                                        mode=append
                                                        [value]
                                                            message="&"+$current_unit.variables.inventory.usables[$i].icon|.png+"="+_ "$current_unit.variables.inventory.usables[$i].description|"="$temp_value"		
                                                            [command]
                                                                {VARIABLE_OP current_unit.variables.personal_gold add $temp_value}
                                                                [set_variables]
                                                                    name=magic_shop.$current_unit.variables.inventory.usables[$i].user_name|s
                                                                    mode=append
                                                                    [insert_tag]
                                                                        name=literal
                                                                        variable=current_unit.variables.inventory.usables[$i]
                                                                    [/insert_tag]
                                                                [/set_variables]
																[clear_variable]
                                                                    name=current_unit.variables.inventory.usables[$i]
                                                                [/clear_variable]
                                                            [/command]
                                                        [/value]
                                                    [/set_variables]
                                                [/then]
                                            [/if]
                                        {NEXT i}
                                        [if]
                                            [variable]
                                                name=sell_item_insert.length
                                                less_than=1
                                            [/variable]
                                            [then]
                                                [message]
                                                    speaker=narrator
                                                    message=_ "You have no items to sell."
                                                    image=wesnoth-icon.png
													side_for=$current_unit.side
                                                [/message]
                                                {VARIABLE in_shop 1}
                                            [/then]
                                            [else]
                                                [message]
                                                    speaker=narrator
                                                    message= _ "Sell which item?"
                                                    [option]
                                                        message ="&"+check.png+"="+_ "End selling."
                                                        [command]
                                                            [modify_side]
                                                                side=$current_unit.side
                                                                gold=$current_unit.variables.personal_gold
                                                            [/modify_side]
                                                            {VARIABLE in_shop 1}
                                                        [/command]
                                                    [/option]
                                                    [insert_tag]
                                                        name=option
                                                        variable=sell_item_insert
                                                    [/insert_tag]
                                                    image=wesnoth-icon.png
                                                [/message]
                                            [/else]
                                        [/if]
                                    [/do]
                                [/while]
                            [/command]
                        [/option]
                        {SHOP_DIVIDER_POTIONS}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_potions
                        [/insert_tag]
						{SHOP_DIVIDER_SCROLLS}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_scrolls
                        [/insert_tag]
                        {SHOP_DIVIDER_TOMES}
                        [insert_tag]
                            name=option
                            variable=shop_item_insert_tomes
                        [/insert_tag]
                    [/message]
                [/do]
            [/while]
        [/command]
    [/set_menu_item]
#enddef

#define WESBAND_TAVERN
    [set_menu_item]
        id=a_wesband_tavern
		image=commands/button_village.png
        description=_ "Enter tavern"
        [filter_location]
            x,y=$tavern_loc_x,$tavern_loc_y
            [filter]
                side=$side_number
                canrecruit=yes
            [/filter]
        [/filter_location]
		[show_if]
		[/show_if]
        [command]
			[store_unit]
	            [filter]
					side=$const.player_sides
	                canrecruit=yes
	            [/filter]
	            variable=hench_num_query
	        [/store_unit]
			[if]
				[variable]
					name=hench_num_query.length
					numerical_equals=1
				[/variable]
				[then]
					{VARIABLE max_hench 2}
				[/then]
				[else]
					{VARIABLE max_hench 1}
				[/else]
			[/if]
			{CLEAR_VARIABLE hench_num_query}
            [store_unit]
                variable=hench_query
                [filter]
                    side=$side_number
                    [not]
                        canrecruit=yes
                    [/not]
                    [filter_wml]
						[variables]
							is_hench=1
						[/variables]
                    [/filter_wml]
                [/filter]
            [/store_unit]
            {VARIABLE hench_number 0}
            {FOREACH hench_query i}
                {VARIABLE_OP hench_number add 1}
            {NEXT i}
            {CLEAR_VARIABLE hench_query}
            [store_unit]
                variable=current_unit
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/store_unit]
            {VARIABLE in_shop 1}
            [while]
                [variable]
                    name=in_shop
                    greater_than=0
                [/variable]
                [do]
                    {CLEAR_VARIABLE tavern_insert}
                    {FOREACH tavern.hench i}
						{VARIABLE tavern.hench[$i].variables.cost $tavern.hench[$i].variables.absolute_value}
						{VARIABLE_OP tavern.hench[$i].variables.cost multiply 3}
						{VARIABLE_OP tavern.hench[$i].variables.cost add $tavern.hench[$i].variables.equipment_value}
						{VARIABLE_OP tavern.hench[$i].variables.cost multiply .8}
						{VARIABLE_OP tavern.hench[$i].variables.cost round 0}
						{RED_COST "tavern.hench[$i].variables.cost"}
						{CLEAR_VARIABLE hench_abilities_list,hench_abilities}
						{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.heals) (
							[set_variables]
								name=hench_abilities_list
								mode=append
								[value]
									name=$tavern.hench[$i].abilities.heals[$macro_i].name
								[/value]
							[/set_variables])
						}
						{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.regenerate) (
							[set_variables]
								name=hench_abilities_list
								mode=append
								[value]
									name=$tavern.hench[$i].abilities.regenerate[$macro_i].name
								[/value]
							[/set_variables])
						}
						{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.resistance) (
							[set_variables]
								name=hench_abilities_list
								mode=append
								[value]
									name=$tavern.hench[$i].abilities.resistance[$macro_i].name
								[/value]
							[/set_variables])
						}
						{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.leadership) (
							[set_variables]
								name=hench_abilities_list
								mode=append
								[value]
									name=$tavern.hench[$i].abilities.leadership[$macro_i].name
								[/value]
							[/set_variables])
						}
						{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.skirmisher) (
							[set_variables]
								name=hench_abilities_list
								mode=append
								[value]
									name=$tavern.hench[$i].abilities.skirmisher[$macro_i].name
								[/value]
							[/set_variables])
						}
						{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.illuminates) (
							[set_variables]
								name=hench_abilities_list
								mode=append
								[value]
									name=$tavern.hench[$i].abilities.illuminates[$macro_i].name
								[/value]
							[/set_variables])
						}
						{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.teleport) (
							[set_variables]
								name=hench_abilities_list
								mode=append
								[value]
									name=$tavern.hench[$i].abilities.teleport[$macro_i].name
								[/value]
							[/set_variables])
						}
						{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.hides) (
							[set_variables]
								name=hench_abilities_list
								mode=append
								[value]
									name=$tavern.hench[$i].abilities.hides[$macro_i].name
								[/value]
							[/set_variables])
						}
						{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.dummy) (
							[set_variables]
								name=hench_abilities_list
								mode=append
								[value]
									name=$tavern.hench[$i].abilities.dummy[$macro_i].name
								[/value]
							[/set_variables])
						}
						[if]
							[variable]
								name=hench_abilities_list.length
								greater_than=0
							[/variable]
							[then]
								[set_variable]
									name=hench_abilities
									[join]
										variable=hench_abilities_list
										key=name
										separator=", "
									[/join]
								[/set_variable]
								{VARIABLE hench_abilities_abstract $hench_abilities}
								{VARIABLE hench_abilities "Abilities: $hench_abilities_abstract
"}
							[/then]
						[/if]	
						{CLEAR_VARIABLE hench_attack_insert}
						{FOREACH tavern.hench[$i].attack o}
							{CLEAR_VARIABLE hench_attack_special_list,hench_attack_special}
							[if]
								[variable]
									name=o
									less_than=1
								[/variable]
								[then]
										{VARIABLE hench_attack_insert "	$tavern.hench[$i].attack[$o].damage|-$tavern.hench[$i].attack[$o].number $tavern.hench[$i].attack[$o].description - $tavern.hench[$i].attack[$o].range $tavern.hench[$i].attack[$o].type
"}
								[/then]
								[else]
									{VARIABLE hench_attack_insert_abstract $hench_attack_insert}
									{VARIABLE hench_attack_insert "$hench_attack_insert_abstract|	$tavern.hench[$i].attack[$o].damage|-$tavern.hench[$i].attack[$o].number $tavern.hench[$i].attack[$o].description - $tavern.hench[$i].attack[$o].range $tavern.hench[$i].attack[$o].type
"}
								[/else]
							[/if]
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.chance_to_hit) (
								[set_variables]
									name=hench_attack_special_list
									mode=append
									[value]
										name=$tavern.hench[$i].attack[$o].specials.chance_to_hit[$macro_i].name
									[/value]
								[/set_variables])
							}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.damage) (
								[set_variables]
									name=hench_attack_special_list
									mode=append
									[value]
										name=$tavern.hench[$i].attack[$o].specials.damage[$macro_i].name
									[/value]
								[/set_variables])
							}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.attacks) (
								[set_variables]
									name=hench_attack_special_list
									mode=append
									[value]
										name=$tavern.hench[$i].attack[$o].specials.attacks[$macro_i].name
									[/value]
								[/set_variables])
							}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.slow) (
								[set_variables]
									name=hench_attack_special_list
									mode=append
									[value]
										name=$tavern.hench[$i].attack[$o].specials.slow[$macro_i].name
									[/value]
								[/set_variables])
							}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.poison) (
								[set_variables]
									name=hench_attack_special_list
									mode=append
									[value]
										name=$tavern.hench[$i].attack[$o].specials.poison[$macro_i].name
									[/value]
								[/set_variables])
							}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.petrifies) (
								[set_variables]
									name=hench_attack_special_list
									mode=append
									[value]
										name=$tavern.hench[$i].attack[$o].specials.petrifies[$macro_i].name
									[/value]
								[/set_variables])
							}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.berserk) (
								[set_variables]
									name=hench_attack_special_list
									mode=append
									[value]
										name=$tavern.hench[$i].attack[$o].specials.berserk[$macro_i].name
									[/value]
								[/set_variables])
							}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.firststrike) (
								[set_variables]
									name=hench_attack_special_list
									mode=append
									[value]
										name=$tavern.hench[$i].attack[$o].specials.firststrike[$macro_i].name
									[/value]
								[/set_variables])
							}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.drains) (
								[set_variables]
									name=hench_attack_special_list
									mode=append
									[value]
										name=$tavern.hench[$i].attack[$o].specials.drains[$macro_i].name
									[/value]
								[/set_variables])
							}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.plague) (
								[set_variables]
									name=hench_attack_special_list
									mode=append
									[value]
										name=$tavern.hench[$i].attack[$o].specials.plague[$macro_i].name
									[/value]
								[/set_variables])
							}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.dummy) (
								[set_variables]
									name=hench_attack_special_list
									mode=append
									[value]
										name=$tavern.hench[$i].attack[$o].specials.dummy[$macro_i].name
									[/value]
								[/set_variables])
							}
							[if]
								[variable]
									name=hench_attack_special_list.length
									greater_than=0
								[/variable]
								[then]
									[set_variable]
										name=hench_attack_special
										[join]
											variable=hench_attack_special_list
											key=name
											separator=", "
										[/join]
									[/set_variable]
									{VARIABLE hench_attack_insert_abstract $hench_attack_insert}
									{VARIABLE hench_attack_insert "$hench_attack_insert_abstract|		<small>Specials: $hench_attack_special</small>
"}
								[/then]
							[/if]							
						{NEXT o}
						{VARIABLE arcane_insert "$(0$tavern.hench[$i].resistance.arcane*-1+100)"}
						{VARIABLE blade_insert "$(0$tavern.hench[$i].resistance.blade*-1+100)"}
						{VARIABLE fire_insert "$(0$tavern.hench[$i].resistance.fire*-1+100)"}
						{VARIABLE cold_insert "$(0$tavern.hench[$i].resistance.cold*-1+100)"}
						{VARIABLE impact_insert "$(0$tavern.hench[$i].resistance.impact*-1+100)"}
						{VARIABLE pierce_insert "$(0$tavern.hench[$i].resistance.pierce*-1+100)"}
						{VARIABLE flat_insert "$(0$tavern.hench[$i].defense.flat*-1+100)"}
						{VARIABLE hills_insert "$(0$tavern.hench[$i].defense.hills*-1+100)"}
						{VARIABLE forest_insert "$(0$tavern.hench[$i].defense.forest*-1+100)"}
						{VARIABLE mountains_insert "$(0$tavern.hench[$i].defense.mountains*-1+100)"}
						{VARIABLE swamp_water_insert "$(0$tavern.hench[$i].defense.swamp_water*-1+100)"}
                        [set_variables]
                            name=tavern_insert
                            mode=append
                            [value]
                                message="&"+$tavern.hench[$i].image|~TC($side_number,magenta)+"="+_ "<span color='green'>$tavern.hench[$i].name|</span>
Level: $tavern.hench[$i].level|, Hitpoints: $tavern.hench[$i].max_hitpoints|, Moves: $tavern.hench[$i].max_moves|, Align: $tavern.hench[$i].alignment
<small><small>Resistances: $arcane_insert|% arcane, $blade_insert|% blade, $fire_insert|% fire, $cold_insert|% cold, $impact_insert|% impact, $pierce_insert|% pierce</small></small>
<small>Movement Costs / Terrain Defense: 
	<small>flat: $tavern.hench[$i].movement_costs.flat| / $flat_insert|, hills: $tavern.hench[$i].movement_costs.hills| / $hills_insert|, forest: $tavern.hench[$i].movement_costs.forest| / $forest_insert|, mountain: $tavern.hench[$i].movement_costs.mountains| / $mountains_insert|, swamp: $tavern.hench[$i].movement_costs.swamp_water| / $swamp_water_insert </small></small>
$hench_abilities|Attacks:
<small>$hench_attack_insert</small>
"="$red_cost|$tavern.hench[$i].variables.cost|$red_cost2|"
                                [command]
                                    [if]
                                        [variable]
                                            name=current_unit.variables.personal_gold
                                            less_than=$tavern.hench[$i].variables.cost
                                        [/variable]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                message=_ "You do not have enough gold to hire that henchman!"
                                                image=wesnoth-icon.png
                                            [/message]
                                        [/then]
                                        [else]
                                            [if]
                                                [variable]
                                                    name=hench_number
                                                    greater_than_equal_to=$max_hench
                                                [/variable]
                                                [then]
                                                    [message]
                                                        speaker=narrator
                                                        message=_ "You already have the maximum amount of henchman! Release one to recruit another."
                                                        image=wesnoth-icon.png
                                                    [/message]
                                                    {VARIABLE in_shop 0}
                                                [/then]
                                                [else]
                                                    {VARIABLE_OP current_unit.variables.personal_gold sub $tavern.hench[$i].variables.cost}
                                                    {VARIABLE tavern.hench[$i].side $current_unit.side}
                                                    {VARIABLE tavern.hench[$i].variables.is_hench 1}
													{VARIABLE tavern.hench[$i].overlays "misc/hero-icon.png"}
                                                    {VARIABLE tavern.hench[$i].upkeep 0}
                                                    [unstore_unit]
                                                        variable=tavern.hench[$i]
                                                        x=1
                                                        y=1
                                                    [/unstore_unit]
													{TELEPORT_TILE 1 1 $current_unit.x $current_unit.y}
                                                    [unstore_unit]
                                                        variable=current_unit
                                                    [/unstore_unit]
                                                    {VARIABLE in_shop 0}
                                                    {CLEAR_VARIABLE "tavern.hench[$i]"}
                                                [/else]
                                            [/if]
                                        [/else]
                                    [/if]
                                [/command]
                            [/value]
                        [/set_variables]
                    {NEXT i}
					[if]
						[variable]
							name=max_hench
							numerical_not_equals=1
						[/variable]
						[then]
							{VARIABLE plural_hench "e"}
						[/then]
						[else]
							{VARIABLE plural_hench "a"}
						[/else]
					[/if]
                    [message]
                        image=$shop_names.tavern3
						speaker=narrator
                        message= _ "In $shop_names.tavern|'s $shop_names.tavern2| you may hire $max_hench henchm$plural_hench|n at a time.
<small>Right-click to "Release Henchman"
You have $current_unit.variables.personal_gold| gold to spend. Who will you take with you?</small>"
                        [option]
                            message ="&"+check.png+"="+_ "End purchase."
                            [command]
                                {VARIABLE in_shop 0}
                            [/command]
                        [/option]
                        [insert_tag]
                            name=option
                            variable=tavern_insert
                        [/insert_tag]
                    [/message]
					[modify_side]
						side=$current_unit.side
						gold=$current_unit.variables.personal_gold
					[/modify_side]
                [/do]
            [/while]
        [/command]
    [/set_menu_item]
#enddef

#store utils

#define SHOP_DIVIDER_MELEE_WEAPONS
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Weapons: Melee"=_ "<small><small>cost</small></small>"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_RANGED_WEAPONS
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Weapons: Ranged"=_ "<small><small>cost</small></small>"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_TORSO_ARMOR
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Armour: Torso"=_ "<small><small>cost</small></small>"
        [command]
        [/command]
    [/option]
	[option]
		{DISPLAY_TORSO_ARMOR (current_unit.variables.inventory.armor.torso[$current_unit.variables.equipment_slots.torso_armor])}=_ "<small><small>equipped</small></small>"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_LEG_ARMOR
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Armour: Leg"=_ "<small><small>cost</small></small>"
        [command]
        [/command]
    [/option]
	[option]
		{DISPLAY_LEGS_ARMOR (current_unit.variables.inventory.armor.legs[$current_unit.variables.equipment_slots.leg_armor])}=_ "<small><small>equipped</small></small>"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_HEAD_ARMOR
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Armour: Head"=_ "<small><small>cost</small></small>"
        [command]
        [/command]
    [/option]
	[option]
		{DISPLAY_HEAD_ARMOR (current_unit.variables.inventory.armor.head[$current_unit.variables.equipment_slots.head_armor])}=_ "<small><small>equipped</small></small>"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_SCROLLS
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Scrolls"=_ "<small><small>cost</small></small>"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_TOMES
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Tomes"=_ "<small><small>cost</small></small>"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_WANDS
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Wands"=_ "<small><small>cost</small></small>"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_POTIONS
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Potions"=_ "<small><small>cost</small></small>"
        [command]
        [/command]
    [/option]
#enddef

#define SHOP_DIVIDER_SHIELDS
    [option]
        message ="&"+misc/blank-hex.png+"="+_ "Armour: Shields"=_ "<small><small>cost</small></small>"
        [command]
        [/command]
    [/option]
	[option]
		{DISPLAY_SHIELD (current_unit.variables.inventory.armor.shield[$current_unit.variables.equipment_slots.shield])}=_ "<small><small>equipped</small></small>"
        [command]
        [/command]
    [/option]
#enddef

#define CREATE_POTION_INSERT_TO_SHOP
	{RANDOM 0..3}
    [if]
        [variable]
            name=random
            numerical_equals=0
        [/variable]
        [then]
            {VARIABLE_OP new_potion_rank rand 0..$dungeon_level.max}
        [/then]
        [else]
            {VARIABLE level_minus_3 $dungeon_level.max}
            {VARIABLE_OP level_minus_3 add  -3}
            [if]
                [variable]
                    name=level_minus_3
                    less_than=0
                [/variable]
                [then]
                    {VARIABLE level_minus_3 0}
                [/then]
            [/if]
            {VARIABLE_OP new_potion_rank rand $level_minus_3..$dungeon_level.max}
        [/else]
    [/if]
    {RANDOM 0..2}
    {VARIABLE_OP new_potion_rank add $random}
	{RANDOM_POTION prob_overworld_shop_potion $new_potion_rank magic_shop.potions[$magic_shop.potions.length]}
#enddef

#define CREATE_SCROLL_INSERT_TO_SHOP
	{RANDOM 0..3}
    [if]
        [variable]
            name=random
            numerical_equals=0
        [/variable]
        [then]
            {VARIABLE_OP new_scroll_rank rand 0..$dungeon_level.max}
        [/then]
        [else]
            {VARIABLE level_minus_3 $dungeon_level.max}
            {VARIABLE_OP level_minus_3 add  -3}
            [if]
                [variable]
                    name=level_minus_3
                    less_than=0
                [/variable]
                [then]
                    {VARIABLE level_minus_3 0}
                [/then]
            [/if]
            {VARIABLE_OP new_scroll_rank rand $level_minus_3..$dungeon_level.max}
        [/else]
    [/if]
    {RANDOM 0..2}
    {VARIABLE_OP new_scroll_rank add $random}
	{RANDOM_SCROLL prob_overworld_shop_scroll $new_scroll_rank magic_shop.scrolls[$magic_shop.scrolls.length]}
#enddef

#define CREATE_TOME_INSERT_TO_SHOP
    [set_variables]
        name=a_tome
        mode=replace
        [value]
            user_name="tome"
            icon="icons/tome"
            description=_ "Tome: Teleport 2 hexes/casting power
Uses simple action"
            usable_self=1
            usable_other_adj=0
            usable_other_dis=0
            usable_adj=0
            usable_dis=0
            command="tome"
            uses=1
            #make book image random
            ground_icon="book1"
            category=usables
            absolute_value=0
            [spell]
                user_name="silver_teleport"
                icon="upgrades/silver_order"
                usable_self=0
                usable_other_adj=0
                usable_other_dis=0
                usable_adj=1
                usable_dis=1
                infinite=1
                command=silver_teleport
                description=_ "Teleport 2 hexes/casting power
Uses simple action"
            [/spell]
        [/value]
    [/set_variables]
    [set_variables]
        name=magic_shop.tomes
        mode=append
        [insert_tag]
            name=value
            variable=a_tome
        [/insert_tag]
    [/set_variables]
#enddef

#define CREATE_HENCH_INSERT_TO_TAVERN
    [if]
        [variable]
            name=dungeon_level.max
            less_than=2
        [/variable]
        [then]
			#{VARIABLE_OP new_hench rand "WBD Orcish Assassin,WBD Lich,WBD Spearman,WBD Elvish Druid"}
            {VARIABLE_OP new_hench rand "WBD Woodsman,WBD Ruffian,WBD Peasant,WBD Brute,WBD Civilian,WBD Initiate,WBD Nobleman,WBD Elf,WBD She Elf"}
		[/then]
    [/if]
    [if]
        [variable]
            name=dungeon_level.max
            less_than=4
        [/variable]
        [not]
            [variable]
                name=dungeon_level.max
                less_than=2
            [/variable]
        [/not]
        [then]
            {VARIABLE_OP new_hench rand "WBD Woodsman,WBD Ruffian,WBD Peasant,WBD Brute,WBD Civilian,WBD Initiate,WBD Nobleman,WBD Elf,WBD She Elf,WBD Dwarvish Fighter,WBD Dwarvish Guardsman,WBD Dwarvish Thunderer,WBD Dwarvish Ulfserker,WBD Elvish Archer,WBD Elvish Fighter,WBD Elvish Shaman,WBD Fencer,WBD Heavy Infantryman,WBD Mage,WBD Bowman,WBD Spearman,WBD Footpad,WBD Thug,WBD Thief,WBD Poacher,WBD Sergeant"}
        [/then]
    [/if]
    [if]
        [variable]
            name=dungeon_level.max
            less_than=6
        [/variable]
        [not]
            [variable]
                name=dungeon_level.max
                less_than=4
            [/variable]
        [/not]
        [then]
            {VARIABLE_OP new_hench rand "WBD Woodsman,WBD Ruffian,WBD Peasant,WBD Brute,WBD Civilian,WBD Initiate,WBD Nobleman,WBD Elf,WBD She Elf,WBD Dwarvish Fighter,WBD Dwarvish Guardsman,WBD Dwarvish Thunderer,WBD Dwarvish Ulfserker,WBD Elvish Archer,WBD Elvish Fighter,WBD Elvish Shaman,WBD Fencer,WBD Heavy Infantryman,WBD Mage,WBD Bowman,WBD Spearman,WBD Footpad,WBD Thug,WBD Thief,WBD Poacher,WBD Sergeant,WBD Dwarvish Steelclad,WBD Dwarvish Stalwart,WBD Dwarvish Thunderguard,WBD Dwarvish Berserker,WBD Elvish Marksman,WBD Elvish Ranger,WBD Elvish Captain,WBD Elvish Hero,WBD Elvish Druid,WBD Elvish Sorceress,WBD Duelist,WBD Shock Trooper,WBD Red Mage,WBD White Mage,WBD Longbowman,WBD Javelineer,WBD Pikeman,WBD Swordsman,WBD Outlaw,WBD Bandit,WBD Lieutenant,WBD Rogue,WBD Trapper"}
        [/then]
    [/if]
    [if]
        [variable]
            name=dungeon_level.max
            greater_than_equal_to=6
        [/variable]
        [then]
            {VARIABLE_OP new_hench rand "WBD Woodsman,WBD Ruffian,WBD Peasant,WBD Brute,WBD Civilian,WBD Initiate,WBD Nobleman,WBD Elf,WBD She Elf,WBD Dwarvish Fighter,WBD Dwarvish Guardsman,WBD Dwarvish Thunderer,WBD Dwarvish Ulfserker,WBD Elvish Archer,WBD Elvish Fighter,WBD Elvish Shaman,WBD Fencer,WBD Heavy Infantryman,WBD Mage,WBD Bowman,WBD Spearman,WBD Footpad,WBD Thug,WBD Thief,WBD Poacher,WBD Sergeant,WBD Dwarvish Steelclad,WBD Dwarvish Stalwart,WBD Dwarvish Thunderguard,WBD Dwarvish Berserker,WBD Elvish Marksman,WBD Elvish Ranger,WBD Elvish Captain,WBD Elvish Hero,WBD Elvish Druid,WBD Elvish Sorceress,WBD Duelist,WBD Shock Trooper,WBD Red Mage,WBD White Mage,WBD Longbowman,WBD Javelineer,WBD Pikeman,WBD Swordsman,WBD Outlaw,WBD Bandit,WBD Lieutenant,WBD Rogue,WBD Trapper,WBD Dwarvish Lord,WBD Dwarvish Sentinel,WBD Dwarvish Dragonguard,WBD Elvish Sharpshooter,WBD Elvish Avenger,WBD Elvish Marshal,WBD Elvish Champion,WBD Elvish Shyde,WBD Elvish Enchantress,WBD Master at Arms,WBD Iron Mauler,WBD Arch Mage,WBD Mage of Light,WBD Master Bowman,WBD Halberdier,WBD Royal Guard,WBD Royal Warrior,WBD Fugitive,WBD Highwayman,WBD General,WBD Assassin,WBD Huntsman,WBD Ranger"}
        [/then]
    [/if]

    [unit]
        side="$(1+$const.max_player_count)"
        type=$new_hench
        x=1
        y=1
        generate_name=yes
        random_traits=yes
        random_gender=yes
        generate_name=yes
    [/unit]
    [store_unit]
        variable=tavern.hench
        mode=append
        [filter]
            x,y=1,1
        [/filter]
        kill=yes
    [/store_unit]
	{VARIABLE z $tavern.hench.length}
	{VARIABLE_OP z sub 1}
	{CREATE_BASE "tavern.hench[$z]"}
	{VARIABLE unit_path "tavern.hench[$z]"}
	{NPC_RACE_BASE "tavern.hench[$z]"}
	[fire_event]
		name=npc_apply_traits
	[/fire_event]
	[fire_event]
		name=npc_apply_items
	[/fire_event]
	[construct_unit]
		variable=tavern.hench[$z]
	[/construct_unit]
	[kill]
		x,y=1,1
    [/kill]
#enddef
